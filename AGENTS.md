# Project Memory (Local AGENTS)

## Project overview
- Pixel Control is designed as a two-part system to orchestrate ManiaPlanet/ShootMania servers: a ManiaControl plugin per game server and a central API server.
- A third stream now exists: `pixel-sm-server/` as a first-party, easily deployable ShootMania dev server package (Docker-based) to test plugin behavior in real game conditions.
- Current repository state is still early-stage for full features, but first-party plugin and dev-server skeletons now exist and are ready for incremental implementation.
- Product direction confirmed with the user: plugin-first execution, multi-mode ShootMania support, local-first developer workflow, and `ressources/` used as reference only.

## Tech stack
- Plugin side (planned): PHP plugin on top of ManiaControl.
- Server side (planned): Laravel API (README-level intention, not yet implemented in this repo).
- Dev server infra (scaffolded in first-party `pixel-sm-server/`): Docker + Docker Compose around ManiaPlanet dedicated server + ManiaControl + MySQL.
- Platform dependencies: ManiaPlanet dedicated server XML-RPC + script callbacks, ManiaControl, MySQL.
- Optional ecosystem integration: ManiaPlanet Web Services OAuth2 (`ressources/oauth2-maniaplanet`).

## Repo layout
- `pixel-control-plugin/`: first-party ManiaControl plugin skeleton (`src/PixelControlPlugin.php`, callback registry, async API shell, queue/retry contracts).
- `pixel-control-server/`: reserved workspace for future backend/API implementation (currently deferred by user; keep only lightweight contract references until backend phase starts).
- `pixel-sm-server/`: first-party Dockerized ShootMania dev stack baseline (`docker-compose.yml`, `Dockerfile`, `scripts/bootstrap.sh`, templates, `.env.example`).
- `.local-dev/`: gitignored local sandbox for mutable ManiaControl/ShootMania experiments outside first-party project trees.
- `ressources/ManiaControl/`: upstream ManiaControl code, runtime scripts, core/plugins, configs.
- `ressources/ManiaControl-Plugin-Examples/`: sample plugins to copy patterns from.
- `ressources/oauth2-maniaplanet/`: official PHP OAuth2 provider package.
- `ressources/maniaplanet-server-with-docker/`: imported dockerized ShootMania+ManiaControl reference stack.
- `ROADMAP.md`: canonical feature roadmap (when user says `ROADMAP`, this file is implied).

## Common commands
- Root checks:
  - `git rev-parse --show-toplevel`
  - `git status`
- Pixel Control backend/API is currently deferred; no server runtime command is canonical for this phase.
- First-party Pixel SM dev stack (from `pixel-sm-server`):
  - `cp .env.example .env`
  - `bash scripts/import-reference-runtime.sh` (optional, copies reference runtime into `pixel-sm-server/runtime/server`)
  - `docker compose up --build`
  - `docker compose down`
  - `docker compose logs -f`
  - `bash scripts/dev-plugin-sync.sh`
  - `bash scripts/qa-wave3-telemetry-replay.sh`
  - `bash scripts/qa-wave4-telemetry-replay.sh`
  - `bash scripts/qa-admin-stats-replay.sh`
- ManiaControl sandbox workflow (copy reference first, then run from `.local-dev/`):
  - `mkdir -p .local-dev`
  - `cp -R ressources/ManiaControl .local-dev/maniacontrol`
  - `cp .local-dev/maniacontrol/configs/server.default.xml .local-dev/maniacontrol/configs/server.xml`
  - `php .local-dev/maniacontrol/ManiaControl.php` (foreground/debug)
- Dedicated server reference startup (from official docs):
  - `ManiaPlanetServer /nodaemon /dedicated_cfg=dedicated_cfg.txt /game_settings=MatchSettings/matchsettings.txt`
- Dockerized ShootMania reference stack (from `ressources/maniaplanet-server-with-docker`):
  - `docker compose up --build`
  - `docker compose down`
  - `docker compose logs -f`
- Reference tests (if phpunit is available in PATH):
  - `phpunit -c phpunittests/phpunit.xml` (from `.local-dev/maniacontrol`)

## Conventions
- Treat `ressources/` as immutable read-only reference code unless explicitly requested to edit it.
- Never run mutable workflows inside `ressources/` (no runtime launches, no log/pid generation, no config rewrites).
- Treat `pixel-sm-server/`, `pixel-control-plugin/`, and `pixel-control-server/` as separate first-party projects inside a monorepo.
- If reference assets are needed by a first-party project, copy/import them into that project directory first (do not bind mutable flows directly to `ressources/`).
- For local experimentation outside first-party projects, use `.local-dev/` (gitignored) as scratch workspace.
- If project-local imports need independent source tracking, initialize them as nested standalone repos inside the target project folder (empty git root + explicit import commit), never under `ressources/`.
- Build new product code in `pixel-control-plugin/` and `pixel-sm-server/` for now; keep `pixel-control-server/` implementation-deferred until explicitly resumed.
- Build first-party dev server automation in `pixel-sm-server/` (do not evolve the imported Docker reference directly unless explicitly requested).
- Keep `API_CONTRACT.md` (repo root) updated whenever plugin->API route expectations change.
- Keep `pixel-control-plugin/FEATURES.md` updated whenever plugin capabilities change.
- For plugin implementation, follow ManiaControl plugin contract conventions:
  - implement `ManiaControl\Plugins\Plugin` methods (`prepare`, `load`, `unload`, metadata getters),
  - wire callbacks/commands via managers,
  - keep settings centralized via `SettingManager`.
- Keep plugin/server contract explicit and versioned (payload schema, idempotency keys, retries, compatibility matrix).
- Multi-mode support is required (do not hardcode Elite-only architecture).
- Authentication choice between plugin and server is not fixed yet; document options in `ROADMAP.md` before locking implementation.
- For Docker/dev-server work, document env var names only (no secret values) and keep secure defaults in `.env.example` style templates.
- After each resolved blocker, append a concise incident memory in this local `AGENTS.md` with: symptom, root cause, applied fix, and validation signal so future runs avoid repeating the same failure.

## CI / release
- No CI workflow files found at repo root (`.github/workflows` absent, `.gitlab-ci.yml` absent).
- No release/versioning process defined yet for first-party Pixel Control code.

## Gotchas
- `pixel-control-server/` implementation is intentionally deferred for this phase; avoid adding backend runtime code there until user re-opens backend work.
- `pixel-sm-server/` now has a first-party baseline, but still requires local runtime assets in `pixel-sm-server/runtime/server/` (dedicated binary + ManiaControl runtime).
- `PIXEL_SM_RUNTIME_SOURCE` and title pack mutable sources must stay outside `ressources/`; helper scripts now fail fast when pointed at reference paths.
- ManiaControl requires valid server + MySQL credentials in `ressources/ManiaControl/configs/server.xml`; never commit credentials.
- `ressources/maniaplanet-server-with-docker/docker-compose.yml` and related XML files include hardcoded credentials; treat them as insecure samples and rotate/rewrite before any real deployment.
- ManiaPlanet XML-RPC port (default 5000) is sensitive and should stay private.
- The imported Docker stack uses `network_mode: host`; published `ports:` are ignored in host mode and Docker Desktop host networking must be enabled (Desktop 4.34+).
- In the imported Dockerfile, `TITLE_PACK` is configurable but `/game_settings` is hardcoded to `MatchSettings/.txt`; multi-mode support needs explicit matchsettings parametrization.
- `ressources/maniaplanet-server-with-docker/TitlePacks/` is not copied by the current Dockerfile (`COPY server .` only), so custom title packs are not auto-included yet.
- `https://www.maniacontrol.com` currently returns an expired certificate in this environment; prefer official docs and GitHub mirrors for references.
- `google_search` tool may return account-validation 403 in this environment; use direct `webfetch` URLs as fallback for web research.
- ManiaControl in the imported runtime crashes on PHP 8.x (`libs/curl-easy/cURL/RequestsQueue.php` Countable signature + AsyncHttpRequest fatal); keep first-party `pixel-sm-server/Dockerfile` on Ubuntu 20.04/PHP 7.4 unless compatibility is explicitly addressed.
- Matchsettings templates without explicit `<map>` entries can trigger `ERROR: Empty playlist`; first-party bootstrap now injects available runtime `.Map.Gbx` entries into `active-matchsettings.txt` to fail-safe local launches.
- Runtime map auto-injection is now restricted to Elite-compatible flows; for Siege/Battle/Joust/Royal scripts, bootstrap fails early with explicit map guidance when `<map>` entries are missing.
- Battle mode in current workflow expects `SMStormBattle@nadeolabs` + `Battle\BattlePro.Script.txt`; using `ShootMania\Battle\Mode.Script.txt` fails in this runtime.
- Official battle title pack download endpoint: `https://maniaplanet.com/ingame/public/titles/download/SMStormBattle@nadeolabs.Title.Pack.gbx`.
- Admin payload control surface currently allows unauthenticated actorless execution (`PixelControl.Admin.ExecuteAction` in temporary trusted mode); before production exposure, implement source authentication (for example HMAC/JWT + timestamp/nonce replay protection) and restrict accepted origins.

## Plugin implementation playbook
- Startup order: `ManiaControl::run()` triggers `Callbacks::ONINIT`, then plugin loading (`PluginManager::loadPlugins()`), then `Callbacks::AFTERINIT`.
- Script callbacks are enabled during connection (`connect()` -> `Server::getScriptManager()->enableScriptCallbacks()`), before plugin load.
- Plugin class requirements: implement `ManiaControl\Plugins\Plugin`, keep file basename equal to class basename, and return `getId() > 0` (unless `DEV_MODE` is enabled).
- Automatic cleanup on unload only applies to implemented listener interfaces (`CallbackListener`, `CommandListener`, `TimerListener`, `ManialinkPageAnswerListener`, `SidebarMenuEntryListener`, `CommunicationListener`, `EchoListener`).
- For typed ShootMania events, use `registerCallbackListener(Callbacks::SM_*, ...)`; this yields typed structures via `ShootManiaCallbacks`.
- Use `registerScriptCallbackListener(...)` only when raw script callback payloads are explicitly needed.
- Keep callback handlers lightweight: ManiaControl loop targets a tight tick (`~2.5ms` sleep budget), so heavy work should be buffered and flushed on timers.
- Prefer async outbound HTTP (`AsyncHttpRequest`) and keep retry/idempotency logic in Pixel Control plugin code, not in callback hot-paths.

## Callback shortlist for Pixel Control P0
- Lifecycle: `CallbackManager::CB_MP_BEGINMATCH`, `CB_MP_ENDMATCH`, `CB_MP_BEGINMAP`, `CB_MP_ENDMAP`, `CB_MP_BEGINROUND`, `CB_MP_ENDROUND`.
- Player state: `PlayerManager::CB_PLAYERCONNECT`, `CB_PLAYERDISCONNECT`, `CB_PLAYERINFOCHANGED`, `CB_PLAYERINFOSCHANGED`.
- Combat/stats: `Callbacks::SM_ONSHOOT`, `SM_ONHIT`, `SM_ONNEARMISS`, `SM_ONARMOREMPTY`, `SM_ONCAPTURE`, `SM_SCORES`.
- Mode-specific extensions: `Callbacks::SM_ELITE_STARTTURN`, `SM_ELITE_ENDTURN`, `SM_JOUST_*`, `SM_ROYAL_*`.
- Useful payload details from typed structures: weapon IDs (`Laser=1`, `Rocket=2`, `Nucleus=3`, `Arrow=5`), damage/distance, shooter/victim positions, capture players and score snapshots.

## Pixel SM server implementation notes
- Reference Docker image copies only `server/` (`COPY server .`), so `TitlePacks/` are missing unless explicitly copied or mounted.
- Reference startup command hardcodes `/game_settings=MatchSettings/.txt`; first-party stack must parameterize matchsettings to unlock multi-mode support.
- First-party networking profiles: bridge-default in `pixel-sm-server/docker-compose.yml`, optional host override in `pixel-sm-server/docker-compose.host.yml`.
- With `network_mode: host`, published `ports:` are ignored; host profile also requires Docker Desktop host networking support (Desktop 4.34+) and free host ports.
- Treat all credentials in imported samples as insecure placeholders and replace them with `.env.example`-style variables only.
- First-party compose now wires `shootmania` healthcheck to `scripts/healthcheck.sh` (DB ping + plugin load marker + XML-RPC TCP probe); keep smoke checks aligned with this readiness contract.
- Mode map pool is mounted via `PIXEL_SM_MAPS_SOURCE` and synced into runtime `UserData/Maps/PixelControl/` at bootstrap.
- Mode matrix smoke helper: `pixel-sm-server/scripts/qa-mode-smoke.sh` validates Elite + Siege + Battle flows.
- Wave-2 replay helper: `pixel-sm-server/scripts/qa-admin-stats-replay.sh` posts deterministic admin/player/combat envelopes into local server ingestion; treat as legacy while backend runtime remains paused.
- Wave-2 replay helper fails fast with `curl: (7)` when backend ingestion is not running on `127.0.0.1:8080`; keep this expected while backend runtime remains paused.
- Wave-3 replay helper: `pixel-sm-server/scripts/qa-wave3-telemetry-replay.sh` runs a local ACK stub, starts the stack with deterministic QA ports, replays admin/player/map actions in-container, validates required telemetry markers, and stores artifacts under `pixel-sm-server/logs/qa/wave3-telemetry-<timestamp>-*`.
- Wave-3 helper now supports deterministic marker fixtures (`PIXEL_SM_QA_TELEMETRY_INJECT_FIXTURES=1` by default) and host-side stub posting through `PIXEL_SM_QA_TELEMETRY_STUB_LOCAL_URL` (default `http://127.0.0.1:18080`) to avoid local `host.docker.internal` DNS issues.
- Wave-4 replay helper: `pixel-sm-server/scripts/qa-wave4-telemetry-replay.sh` validates reconnect/side-change/team-aggregate/win-context/veto markers, stores artifacts under `pixel-sm-server/logs/qa/wave4-telemetry-<timestamp>-*`, and indexes canonical evidence in `pixel-sm-server/logs/qa/wave4-evidence-index-20260220.md`.
- Admin payload simulation helper: `pixel-sm-server/scripts/qa-admin-payload-sim.sh` simulates future server-originated `PixelControl.Admin.ListActions`/`PixelControl.Admin.ExecuteAction` payloads over ManiaControl communication socket and stores artifacts under `pixel-sm-server/logs/qa/admin-payload-sim-<timestamp>/`.
- Admin payload simulation helper now supports `PIXEL_SM_ADMIN_SIM_OUTPUT_ROOT` to force run-local artifact roots while preserving default output behavior.
- Automated orchestration helper is now first-party: `pixel-sm-server/scripts/test-automated-suite.sh`.
- Orchestrator defaults to `--modes elite,joust`, supports `--modes <csv>` and optional `--with-mode-smoke`, and writes deterministic run artifacts under `pixel-sm-server/logs/qa/automated-suite-<timestamp>/` (`run-manifest.json`, `coverage-inventory.json`, `check-results.ndjson`, `suite-summary.json`, `suite-summary.md`, `manual-handoff.md`).
- Orchestrator required coverage includes per-mode launch smoke + wave-4 plugin-only marker validation, admin response/payload/correlation assertions, and strict elite gate (`qa-wave3-telemetry-replay.sh` + strict `qa-wave4-telemetry-replay.sh`); it exits non-zero on required check failures.
- Automated suite keeps live combat callbacks manual-only (`OnShoot`, `OnHit`, `OnNearMiss`, `OnArmorEmpty`, `OnCapture`) and routes that boundary to `manual-handoff.md`.
- In current battle-mode runtime, direct fake-player `forcePlayerTeam(...)` calls can intermittently return `UnknownPlayer`; wave-4 replay now treats those as non-fatal warnings and relies on deterministic fixture envelopes for required marker closure.
- Wave-5 manual evidence helpers are now first-party: `pixel-sm-server/scripts/manual-wave5-session-bootstrap.sh`, `pixel-sm-server/scripts/manual-wave5-ack-stub.sh`, `pixel-sm-server/scripts/manual-wave5-log-export.sh`, and `pixel-sm-server/scripts/manual-wave5-evidence-check.sh`.
- Recommended manual payload capture flow: run local ACK stub on host `127.0.0.1:18080`, then restart plugin transport with `PIXEL_CONTROL_API_BASE_URL=http://host.docker.internal:18080 bash scripts/dev-plugin-sync.sh` before real-client scenarios.
- QA launch smoke supports multi-file compose selection through `PIXEL_SM_QA_COMPOSE_FILES` (CSV, default `docker-compose.yml`).
- Plugin fast-sync helper (`pixel-sm-server/scripts/dev-plugin-sync.sh`) supports multi-file compose selection through `PIXEL_SM_DEV_COMPOSE_FILES` (CSV, default `docker-compose.yml`) and leaves stack running for iteration.
- Plugin hot-sync helper (`pixel-sm-server/scripts/dev-plugin-hot-sync.sh`) now supports plugin-only refresh without shootmania container restart: it copies plugin source into runtime and restarts ManiaControl process only (dedicated server PID should remain unchanged).
- Plugin transport runtime now also supports queue/dispatch/heartbeat knobs through `PIXEL_CONTROL_QUEUE_MAX_SIZE`, `PIXEL_CONTROL_DISPATCH_BATCH_SIZE`, and `PIXEL_CONTROL_HEARTBEAT_INTERVAL_SECONDS`.
- In bridge-network local dev, ManiaControl communication socket may fail if it binds to external published IP; for reliable plugin communication-method QA, ensure runtime `CommunicationManager` listens on `0.0.0.0` (runtime compatibility patch currently applied in `pixel-sm-server/runtime/server/ManiaControl/core/Communication/CommunicationManager.php`).
- If default local ports are occupied during dev fast sync, override runtime ports inline (for example `PIXEL_SM_XMLRPC_PORT=57000 PIXEL_SM_GAME_PORT=57100 PIXEL_SM_P2P_PORT=57200 bash scripts/dev-plugin-sync.sh`).
- For LAN peer-play sessions where login-based join URLs resolve to public IP and fail/hang, use local server list join and, if needed, restart with legacy gameplay ports (`PIXEL_SM_GAME_PORT=2350 PIXEL_SM_P2P_PORT=3450`) for compatibility.
- LAN local-server-list discovery is now considered stable on native gameplay ports; keep `.env` defaults on `PIXEL_SM_GAME_PORT=2350` and `PIXEL_SM_P2P_PORT=3450` unless a session explicitly needs temporary overrides.
- Incident memory (2026-02-20, server not visible/reachable on LAN):
  - symptom: server missing from local list or join failures/hangs while using non-native gameplay ports.
  - root cause: gameplay ports were moved away from native defaults and login URL resolution could route to public IP path.
  - fix: pin gameplay ports back to native values (`PIXEL_SM_GAME_PORT=2350`, `PIXEL_SM_P2P_PORT=3450`) and join through local server list.
  - validation: server appears in local list and remote client reaches spawn successfully.
- Host-side direct XML-RPC clients against published port can be reset by server access policy; reliable automation is to run dedicated API calls from inside the `shootmania` container using ManiaControl's bundled PHP client (`Maniaplanet\DedicatedServer\Connection::factory('127.0.0.1', $PIXEL_SM_XMLRPC_PORT, ...)`).
- For plugin payload evidence capture, a local ACK stub on host port `18080` works with container target `host.docker.internal:18080`; writing raw envelopes as NDJSON in `pixel-sm-server/logs/dev/` enables deterministic inspection of emitted payload fields.
- Outage/recovery QA is reproducible by toggling that local ACK stub: stop stub -> observe `outage_entered`/`retry_scheduled` markers; restart stub -> observe `outage_recovered` + `recovery_flush_complete` in `pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log`.
- Incident memory (2026-02-21, repeated `retry_scheduled` spam for `host.docker.internal:18080`):
  - symptom: ManiaControl log repeatedly emitted `[PixelControl][queue][retry_scheduled] ... Failed to connect to host.docker.internal port 18080: Connection refused`.
  - root cause: plugin transport target (`PIXEL_CONTROL_API_BASE_URL=http://host.docker.internal:18080`) was configured, but no ACK/backend listener was running on host port `18080`.
  - fix: start local ACK stub (`bash pixel-sm-server/scripts/manual-wave5-ack-stub.sh --output pixel-sm-server/logs/dev/live-ack-stub.ndjson`) so plugin retries can recover and flush.
  - validation: `ManiaControl.log` showed `outage_recovered` then `recovery_flush_complete`, and repeated retry warnings stopped.
- `connectFakePlayer` + forced map transitions (`restartMap`/`nextMap`) can trigger admin-flow callbacks and at least `OnScores` combat envelope shape validation, but real client gameplay is still required for non-zero shot/hit/miss/kill counters.
- Manual combat observability logs are now emitted with prefix `[Pixel Plugin]` for `OnShoot`/`OnHit`/`OnNearMiss`/`OnArmorEmpty`/`OnCapture`/`OnScores`; monitor with `tail -f pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log | grep --line-buffered -E '\[Pixel Plugin\]'`.
- Incident memory (2026-02-20, long-lived in-memory combat stats retention):
  - symptom: concern that combat counters persisted in plugin memory for the full server uptime and could accumulate unnecessary player rows.
  - root cause: `PlayerCombatStatsStore` was runtime-only but reset only on plugin reload/restart, so retention window matched long-lived process lifetime.
  - fix: reset combat counter store + aggregate baselines on `match.begin` and `map.begin` lifecycle boundaries to keep retention bounded to active match/map windows.
  - validation: `MatchDomainTrait::buildLifecycleAggregateTelemetry()` now calls reset helper on `match.begin|map.begin`, and `FEATURES.md`/`docs/event-contract.md` describe bounded non-persistent retention.
- Incident memory (2026-02-20, communication socket bind failure in containerized QA):
  - symptom: `CommunicationManager` raised `Could not bind to tcp://<public-ip>:31501: Cannot assign requested address`, and plugin communication methods were unavailable.
  - root cause: runtime `CommunicationManager` attempted to bind the socket to `ManiaControl->server->ip` (external published IP not present inside bridge container network).
  - fix: bind communication socket to `0.0.0.0` in runtime `CommunicationManager` and restart stack.
  - validation: ManiaControl log now shows `Socket 0.0.0.0:31501 Successfully created!`, and `PixelControl.Admin.ListActions` returns delegated action catalog over communication socket.
- Incident memory (2026-02-20, wave-4 strict replay produced empty capture):
  - symptom: `qa-wave4-telemetry-replay.sh` failed strict marker validation with zero captured envelopes.
  - root cause: local ACK stub port `18080` was already occupied by another stub session, so replay capture file remained empty for that run.
  - fix: stop conflicting stub session before replay and rerun strict wave-4 replay.
  - validation: strict replay passed with marker closure in `pixel-sm-server/logs/qa/wave4-telemetry-20260220-193214-markers.json`.
- Incident memory (2026-02-21, external admin payload actor requirements):
  - symptom: server-originated `PixelControl.Admin.ExecuteAction` calls required `actor_login` and returned `actor_not_found` when omitted, blocking actorless server orchestration.
  - root cause: delegated action flow always resolved a connected actor and always applied plugin permission checks before gateway execution.
  - fix: communication-path execution now enables actorless mode (`allow_actorless`) and skips plugin permission checks in temporary trusted mode (`security_mode=payload_untrusted`); gateway supports actorless force/auth flows using native ManiaControl APIs.
  - validation: PHP lint passes on `AdminControlDomainTrait`/`NativeAdminGateway`, docs updated in `pixel-control-plugin/docs/admin-capability-delegation.md`, `pixel-control-plugin/docs/event-contract.md`, and `API_CONTRACT.md`.
- Incident memory (2026-02-21, pause.end had no visible gameplay effect in delegated admin flow):
  - symptom: `pause.start` could pause gameplay, but `pause.end` returned success without resuming match state in some mode/script combinations.
  - root cause: pause delegation relied on pause events/partial commands and did not consistently unwind warmup/round-forcing side effects across script implementations.
  - fix: `NativeAdminGateway::applyPauseState(false)` now uses a broader compatibility sequence (`Command_SetPause=false`, `Command_ForceWarmUp=false`, `Command_ForceEndRound=false`, plus `ModeScriptEventManager::endPause()` and `stopManiaPlanetWarmup()` fallback).
  - validation: PHP lint passes, plugin hot-sync completed, and delegated `pause.start`/`pause.end` payload calls return success with compatibility marker `script_event_plus_mode_commands`.
- Incident memory (2026-02-21, Elite turn callbacks missing lifecycle round telemetry):
  - symptom: manual Elite gameplay produced `OnEliteStartTurn`/`OnEliteEndTurn` mode events and `scores_section=EndTurn`, but no lifecycle `round.begin`/`round.end` envelopes.
  - root cause: lifecycle normalization mapped only ManiaPlanet round callbacks; Elite turn callbacks were emitted only under `mode` category.
  - fix: mode handler now projects Elite turn callbacks into lifecycle enqueue path, and lifecycle variant resolver maps Elite start/end turn callback identifiers to `round.begin`/`round.end`.
  - validation: PHP lint passes on `CoreDomainTrait`/`LifecycleDomainTrait`, docs updated in `FEATURES.md`, `docs/event-contract.md`, `docs/schema/event-name-catalog-2026-02-20.1.json`, and `docs/manual-feature-test-todo.md`.
- Incident memory (2026-02-21, player callbacks emitted `player.unknown` instead of `player.connect`/`player.disconnect`):
  - symptom: manual NDJSON capture showed `event_name=pixel_control.player.maniacontrol_players_player` and `payload.event_kind=player.unknown` even when connectivity delta clearly indicated connect/disconnect transitions.
  - root cause: queue extraction used callback argument shape (`ManiaControl\Players\Player` object) as source callback; ManiaControl dispatch does not pass callback name to listener params, so transition mapping never saw `PlayerManagerCallback.*` identifiers.
  - fix: player pipeline now resolves a semantic player source callback before envelope creation (`CB_PLAYERCONNECT`/`CB_PLAYERDISCONNECT`/`CB_PLAYERINFOCHANGED`/`CB_PLAYERINFOSCHANGED`) using callback args + cached connectivity transitions; player argument extraction now scans all args instead of only the first.
  - validation: PHP lint passes on `PipelineDomainTrait` and `PlayerDomainTrait`; next runtime reconnect should emit `payload.event_kind=player.connect|player.disconnect|player.info_changed|player.infos_changed` with normalized `event_name` matching `PlayerManagerCallback.*`.
- Incident memory (2026-02-21, admin player actions missing `admin_correlation` on player events):
  - symptom: after `player.force_team` test, player telemetry showed `state_delta.team_id.changed=true` but `payload.admin_correlation.correlated` stayed false.
  - root cause: admin-correlation cache (`recentAdminActionContexts`) was populated from lifecycle enqueue path only; direct admin execute path did not seed context for player-targeted actions, so player-domain correlation could not match recent admin intent.
  - fix: `AdminControlDomainTrait::executeDelegatedAdminAction()` now records correlation context on successful admin execution (action name/type/target scope/target id/initiator/actor/observed_at) via `rememberAdminActionCorrelationContext(...)`.
  - validation: runtime plugin source contains the new correlation helper methods in `Domain/Admin/AdminControlDomainTrait.php`; QA checklist now states precondition that positive correlation checks require admin action response `success=true`.
- Incident memory (2026-02-21, orchestrator preflight incorrectly rejected readable scripts):
  - symptom: `test-automated-suite.sh` failed immediately with `Missing executable script: .../qa-mode-smoke.sh` before any QA checks ran.
  - root cause: preflight used `-x` checks even though helper scripts are invoked via `bash <script>` and may intentionally be non-executable in git metadata.
  - fix: preflight now validates script presence (`-f`) instead of executable bit.
  - validation: default orchestrator run completed to full check execution and produced passing summary at `pixel-sm-server/logs/qa/automated-suite-20260221-212244/suite-summary.json`.
- Incident memory (2026-02-21, admin response/payload correlation false negatives in automated suite):
  - symptom: correlation checks failed although admin payload capture succeeded, because successful actions like `map.skip`/`map.restart` had no deterministic matching `admin_action.action_name` in captured envelopes.
  - root cause: correlation required every successful admin action from response matrix, but captured payload stream only guarantees deterministic lifecycle/system-facing action names for a subset in this environment.
  - fix: correlation now targets an explicit deterministic allowlist (`warmup.extend`, `warmup.end`, `pause.end`) and supports alias matching (`warmup.status`, `pause.end`) for script-generated lifecycle envelopes.
  - validation: full default run passed with `overall_status=passed` at `pixel-sm-server/logs/qa/automated-suite-20260221-212244/suite-summary.json`, elite-only rerun passed at `pixel-sm-server/logs/qa/automated-suite-20260221-213008/suite-summary.json`, and final full default re-validation passed with `checks_total=31`/`passed=31` at `pixel-sm-server/logs/qa/automated-suite-20260221-214203/suite-summary.json`.

## Current execution status (2026-02-20)
- Active execution direction: plugin-first and dev-server-first; backend/API implementation is paused by user for now.
- Plugin schema baseline remains `2026-02-20.1`; wave-5 keeps version unchanged and continues additive optional fields only.
- Native-admin delegation refactor plan (`PLAN-maniacontrol-native-admin-delegation-refactor.md`) is now complete through phase 6:
  - plugin control surface delegates map/warmup/pause/vote/player/auth execution to ManiaControl native services,
  - permission model enforced through native plugin rights,
  - rollout safety/rollback procedure documented,
  - docs synchronized in `pixel-control-plugin/FEATURES.md`, `pixel-control-plugin/docs/event-contract.md`, `pixel-control-plugin/docs/admin-capability-delegation.md`, and `API_CONTRACT.md` note.
- Admin delegation QA evidence set is captured in `pixel-sm-server/logs/qa/admin-delegation-20260220-1926/` (action matrix, permission matrix, non-Elite fallback, telemetry regression summary, acceptance summary).
- Wave-5 plugin hardening delivered:
  - deterministic identity validation on enqueue/dispatch (`drop_identity_invalid` warning + queue counter `dropped_on_identity_validation`),
  - additive player constraint telemetry (`constraint_signals`) for forced-team/slot-policy context with deterministic availability/fallback reasons,
  - callback hot-path safety via dedicated-policy cache refresh on load/heartbeat and cached reads in player callbacks.
- Wave-5 deterministic QA indexing is complete:
  - canonical index: `pixel-sm-server/logs/qa/wave5-evidence-index-20260220.md`,
  - strict replay closure artifact set: `pixel-sm-server/logs/qa/wave4-telemetry-20260220-143317-*`,
  - fixture-off plugin-only baseline artifact set: `pixel-sm-server/logs/qa/wave4-telemetry-20260220-143433-*`,
  - fixture-off pre-profile strict failure retained for traceability: `pixel-sm-server/logs/qa/wave4-telemetry-20260220-143020-*`.
- Wave-5 manual evidence contract is standardized:
  - canonical directory: `pixel-sm-server/logs/manual/wave5-real-client-20260220/`,
  - matrix file: `pixel-sm-server/logs/manual/wave5-real-client-20260220/MANUAL-TEST-MATRIX.md` (`W5-M01..W5-M10`),
  - required per-session templates: `SESSION-<id>-{notes.md,payload.ndjson,evidence.md}`,
  - index + completeness checker flow: `INDEX.md` + `bash scripts/manual-wave5-evidence-check.sh --manual-dir ...` (now requires matrix presence).
- Final wave-5 handoff artifact is published: `HANDOFF-autonomous-wave-5-2026-02-20.md`.
- Wave-1 manual gameplay closure remains pending by user choice:
  - user said manual gameplay tests will be run later,
  - keep `PLAN-autonomous-execution-wave-1.md` manual `P7.2/P7.3` evidence closure pending until user provides gameplay captures.
- Wave-4/wave-5 real-client gameplay validation remains pending for plugin-only evidence (non-fixture reconnect/side-change/veto actor behavior under real player flow).
- Backend note:
  - `pixel-control-server/` code changes were rolled back on user request,
  - future API behavior must be tracked in `API_CONTRACT.md` until backend work is re-opened.
- Where we stopped: wave-5 core work + native-admin delegation refactor are complete; remaining open validation is user-run real-client gameplay/evidence closure.
- Map draft/veto implementation (2026-02-21) is now added to plugin-first codebase:
  - feature subtree: `pixel-control-plugin/src/VetoDraft/` (`VetoDraftCatalog`, `MapPoolService`, `MatchmakingVoteSession`, `TournamentSequenceBuilder`, `TournamentDraftSession`, `VetoDraftCoordinator`, `VetoDraftQueueApplier`),
  - integration trait: `pixel-control-plugin/src/Domain/VetoDraft/VetoDraftDomainTrait.php`, wired through `PixelControlPlugin` + `CoreDomainTrait` periodic timer,
  - command surface: `/pcveto ...` and `//pcveto ...` (dual command-channel registration so both user and admin chat prefixes route to veto handler; control/override rights enforced for privileged operations),
  - runtime defaults are now admin-configurable through chat (`//pcveto mode <matchmaking|tournament>`, `//pcveto duration <seconds>`),
  - player-first matchmaking flow now auto-starts configured `matchmaking_vote` on first `vote` request when no active session exists (tournament auto-start intentionally out-of-scope in this phase),
  - chat observability now emits explicit launch marker (`Matchmaking veto launched ...`) and explicit queued map list (`Queued maps:`) after queue apply,
  - communication methods: `PixelControl.VetoDraft.Start`, `PixelControl.VetoDraft.Action`, `PixelControl.VetoDraft.Status`, `PixelControl.VetoDraft.Cancel`,
  - lifecycle map telemetry now exposes authoritative veto state through `map_rotation.veto_draft_mode`, `map_rotation.veto_draft_session_status`, `veto_draft_actions`, and `veto_result`.
- Draft/veto runtime settings now available (env + setting equivalents):
  - `PIXEL_CONTROL_VETO_DRAFT_ENABLED`,
  - `PIXEL_CONTROL_VETO_DRAFT_COMMAND`,
  - `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_MODE`,
  - `PIXEL_CONTROL_VETO_DRAFT_MATCHMAKING_DURATION_SECONDS`,
  - `PIXEL_CONTROL_VETO_DRAFT_TOURNAMENT_ACTION_TIMEOUT_SECONDS`,
  - `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_BEST_OF`,
  - `PIXEL_CONTROL_VETO_DRAFT_LAUNCH_IMMEDIATELY`.
- Elite veto test pool now includes 9 curated Elite maps under `pixel-sm-server/maps/elite/` and Elite matchsettings references only those entries in `pixel-sm-server/templates/matchsettings/elite.txt`.
- Deterministic QA evidence for this feature is stored at `pixel-sm-server/logs/qa/map-draft-veto-20260221-executor/` (`qa-summary.md` + `acceptance-checklist.md`).
- Server-orchestrated veto simulation helper is now first-party: `pixel-sm-server/scripts/qa-veto-payload-sim.sh` (commands: `status`, `start`, `action`, `cancel`, `matrix`).
- Veto payload simulation evidence is captured under `pixel-sm-server/logs/qa/veto-payload-sim-<timestamp>/` (latest successful dynamic-turn run: `veto-payload-sim-20260221-223726/summary.md`).
- Queue application now follows a DIP-friendly runtime adapter boundary (`MapRuntimeAdapterInterface` + `ManiaControlMapRuntimeAdapter`), enabling deterministic adapter-level smoke validation without booting full ManiaControl runtime.
- Live container/runtime map-application validation remains recommended before production rollout even though logic-level queue behavior is smoke-validated (`veto_draft_queue_apply_smoke_ok`).
- Incident memory (2026-02-21, `//pcveto maps` no-op in chat):
  - symptom: admin chat prefix command `//pcveto maps` produced no visible veto handler response.
  - root cause: veto command listener was only registered on non-admin command channel; ManiaControl routes `//` messages through admin command listeners.
  - fix: register veto command on both command channels (`adminCommand=false` and `adminCommand=true`) in `VetoDraftDomainTrait`.
  - validation: PHP lint passes on plugin trait; runtime payload/status checks still report command `pcveto` enabled; matrix payload flow remains green.
- Incident memory (2026-02-21, static tournament actor matrix produced false-negative step):
  - symptom: first `qa-veto-payload-sim.sh matrix` run reported one `actor_not_allowed` tournament action despite healthy session progression.
  - root cause: matrix used static actor sequence that could desync from runtime `current_step.team` turn owner.
  - fix: matrix tournament loop now reads live status snapshot each turn and selects actor dynamically from `current_step.team` before sending action payload.
  - validation: rerun `veto-payload-sim-20260221-223726/summary.md` shows all tournament action steps `success=true` with no `actor_not_allowed` rows.
- Incident memory (2026-02-21, draft timeout smoke expectation mismatch):
  - symptom: timeout smoke scenario failed with `timeout event missing`.
  - root cause: tournament session enforces minimum timeout floor of 10 seconds; test used 1-second assumption with insufficient elapsed delta.
  - fix: adjust smoke ticks to exceed enforced minimum timeout and re-run scenario.
  - validation: corrected smoke run output `veto_draft_extended_smoke_ok`.
- Incident memory (2026-02-21, BO1 completion expectation mismatch):
  - symptom: BO1 smoke check failed with `bo1 map count mismatch` after partial actions.
  - root cause: BO1 sequence still requires full ban timeline (`map_pool_size - 1` bans) before automatic decider lock.
  - fix: complete full BO1 ban sequence (or equivalent timeout progression) before asserting final series map order.
  - validation: corrected smoke run completed with one-map series order and output `veto_draft_extended_smoke_ok`.

## Additional execution status (2026-02-21, BO/maps/score controls)
- Series policy controls are now first-party in plugin runtime:
  - state owner: `pixel-control-plugin/src/SeriesControl/SeriesControlState.php` (+ catalog/interface),
  - runtime fields: `best_of`, `maps_score.team_a|team_b`, `current_map_score.team_a|team_b`, metadata (`updated_at`, `updated_by`, `update_source`).
- Chat/admin surfaces now support series policy operations:
  - `//pcveto config` prints runtime series snapshot (BO write removed from `pcveto`; use `pcadmin` actions),
  - `//pcadmin match.bo.set best_of=<odd>`,
  - `//pcadmin match.bo.get`,
  - `//pcadmin match.maps.set target_team=<0|1|red|blue> maps_score=<int>`,
  - `//pcadmin match.maps.get`,
  - `//pcadmin match.score.set target_team=<0|1|red|blue> score=<int>`,
  - `//pcadmin match.score.get`.
- Communication/admin surfaces now include additive series controls:
  - delegated actions: `match.bo.set`, `match.bo.get`, `match.maps.set`, `match.maps.get`, `match.score.set`, `match.score.get` via `PixelControl.Admin.ExecuteAction`,
  - additive `series_targets` snapshots in `PixelControl.Admin.ListActions` and `PixelControl.VetoDraft.Status`,
  - lifecycle `map_rotation` telemetry now includes additive `series_targets` snapshot.
- BO precedence contract is explicit in runtime:
  - tournament start honors explicit request `best_of` first,
  - omitted `best_of` falls back to runtime series-policy default.
- Deterministic evidence captured for this scope:
  - admin matrix: `pixel-sm-server/logs/qa/admin-payload-sim-20260221-231000/summary.md`,
  - veto matrix: `pixel-sm-server/logs/qa/veto-payload-sim-20260221-231032/summary.md`,
  - series set/status checks: `pixel-sm-server/logs/qa/admin-payload-sim-20260221-231222/execute-match-series-set.json`, `pixel-sm-server/logs/qa/admin-payload-sim-20260221-231231/execute-match-series-status.json`,
  - BO-default fallback check (`best_of=7` without explicit start parameter): `pixel-sm-server/logs/qa/veto-payload-sim-20260221-231335/start.json`.
- Fresh revalidation evidence (2026-02-22):
  - admin matrix rerun summary: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-004714/summary.md`.
  - veto matrix rerun summary: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-004758/summary.md`.
- Incident memory (2026-02-21, QA veto matrix precondition failure):
  - symptom: `qa-veto-payload-sim.sh matrix` failed immediately with `Service 'shootmania' is not running`.
  - root cause: local compose stack was not running when simulation started.
  - fix: start stack from `pixel-sm-server` using `docker compose up -d --build`, then rerun simulation.
  - validation: rerun completed successfully with summary at `pixel-sm-server/logs/qa/veto-payload-sim-20260221-231032/summary.md`.
- Incident memory (2026-02-22, QA admin matrix precondition failure):
  - symptom: `qa-admin-payload-sim.sh matrix` failed immediately with `Service 'shootmania' is not running`.
  - root cause: local compose stack was down before communication-matrix replay started.
  - fix: start stack from `pixel-sm-server` using `docker compose up -d --build`, then rerun admin matrix.
  - validation: rerun completed successfully with summary at `pixel-sm-server/logs/qa/admin-payload-sim-20260222-004714/summary.md`.
- Automated suite hardening closure (2026-02-22):
  - final green orchestrator evidence: `pixel-sm-server/logs/qa/automated-suite-20260222-003125/` (`suite-summary.json`, `suite-summary.md`, `check-results.ndjson`) with `checks_total=39`, `passed=39`, `required_failures=0`.
  - latest execution revalidation evidence: `pixel-sm-server/logs/qa/automated-suite-20260222-094958/` (`suite-summary.json`, `suite-summary.md`, `check-results.ndjson`, `manual-handoff.md`) with `checks_total=39`, `passed=39`, `required_failures=0`.
- Incident memory (2026-02-22, false-positive suite failures from recovery races in automated veto checks):
  - symptom: `test-automated-suite.sh` intermittently failed `mode.*.veto.matrix` with `Socket connect failed to 127.0.0.1:31501 (111 Connection refused)` right after recovery relaunch, despite subsequent manual reruns succeeding.
  - root cause: orchestrator retry path relaunched shootmania but retried communication-backed steps before ManiaControl communication socket was ready; additional container recreation churn increased race frequency.
  - fix: harden `pixel-sm-server/scripts/test-automated-suite.sh` recovery helper to (a) centralize retry execution, (b) remove stale shootmania containers by discovered name pattern before relaunch, and (c) block on communication socket readiness (`PIXEL_SM_AUTOMATED_SUITE_COMM_HOST/PORT/WAIT_ATTEMPTS`, defaults `127.0.0.1:31501`, `45`) before retrying communication steps.
  - validation: full orchestrator rerun passed end-to-end at `pixel-sm-server/logs/qa/automated-suite-20260222-003125/suite-summary.json`.

## Additional execution status (2026-02-22, crash-recovery score commands)
- Admin control surface now supports manual score recovery actions for BO/map continuity after runtime/script reset:
  - `match.maps.set target_team=<0|1|red|blue> maps_score=<int>` (maps won in current BO),
  - `match.score.set target_team=<0|1|red|blue> score=<int>` (rounds won on current map).
- Team selector normalization is now canonical in runtime policy state (`0|blue|team_a|a` -> `team_a`, `1|red|team_b|b` -> `team_b`), including quoted input tolerance for `target_team` values.
- `series_targets` snapshots now include additive recovery fields:
  - `maps_score.team_a|team_b`,
  - `current_map_score.team_a|team_b`.
- QA admin matrix now includes deterministic coverage for `match.bo.get`, `match.bo.set`, `match.maps.get/set`, and `match.score.get/set` in `pixel-sm-server/scripts/qa-admin-payload-sim.sh`.
- Latest evidence:
  - first matrix run before runtime sync: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-101744/summary.md` (new actions reported `action_unknown`),
  - post hot-sync successful matrix run: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-101845/summary.md`,
  - renamed-action matrix rerun summary: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-104241/summary.md` (`match.bo.get/set`, `match.maps.get/set`, `match.score.get/set` all `success=true`),
  - payload artifacts: `execute-15-match-bo-set.json`, `execute-18-match-maps-get.json`, `execute-21-match-score-get.json` under `pixel-sm-server/logs/qa/admin-payload-sim-20260222-104241/`.
- Incident memory (2026-02-22, action rename from `match.series.*` to explicit BO/maps/score get-set):
  - symptom: `match.series.set/status` naming mixed BO policy and score-recovery semantics, and did not expose explicit read actions for maps/round scores.
  - root cause: first design bundled unrelated policy targets into one command family, while crash-recovery flow requires explicit operations (`bo`, `maps_score`, `current_map_score`) with deterministic getters.
  - fix: replace catalog/actions with `match.bo.set`, `match.bo.get`, `match.maps.set`, `match.maps.get`, `match.score.set`, `match.score.get`; remove runtime `map_count_target`/`team_*_score_target` fields from `SeriesControlState`; update docs and QA matrix script accordingly.
  - validation: `php -l` passed on touched plugin files, admin matrix passed at `admin-payload-sim-20260222-104241/summary.md`, and veto matrix non-regression passed at `veto-payload-sim-20260222-104323/summary.md`.
- Incident memory (2026-02-22, new admin actions returned `action_unknown` right after code edit):
  - symptom: `qa-admin-payload-sim.sh matrix` reported `match.maps.set` / `match.score.set` as `action_unknown` although source code defined both actions.
  - root cause: running ManiaControl process was still on previous plugin code (runtime plugin not hot-synced/reloaded after local edits).
  - fix: run `bash pixel-sm-server/scripts/dev-plugin-hot-sync.sh` to sync plugin into container and restart ManiaControl process only, then rerun matrix.
  - validation: rerun matrix reported `match.maps.set` and `match.score.set` as `success=true`, `code=ok` in `admin-payload-sim-20260222-101845/summary.md`.

## Additional execution status (2026-02-22, modular automated-suite action descriptors)
- `pixel-sm-server/scripts/test-automated-suite.sh` now resolves required admin action coverage from modular descriptor scripts instead of hardcoded action arrays.
- Descriptor root: `pixel-sm-server/scripts/automated-suite/admin-actions/` (one `.sh` file per admin action key).
- Descriptor contract is documented in `pixel-sm-server/scripts/automated-suite/README.md`.
- Current descriptor set covers 24 actions including BO/maps/score get-set (`match.bo.set/get`, `match.maps.set/get`, `match.score.set/get`).

## Additional execution status (2026-02-22, veto help UX + series persistence hardening)
- `pcveto help` now resolves visibility from caller permissions and effective mode:
  - non-admin callers do not receive admin-only docs,
  - admin callers receive mode-specific admin docs only,
  - effective mode policy is now explicit: active session mode when running, otherwise configured default mode, with deterministic fallback guidance when mode context is invalid.
- Series persistence scope is now durable through ManiaControl settings:
  - persisted keys: `best_of`, `maps_score.team_a|team_b`, `current_map_score.team_a|team_b`,
  - mutation paths covered: `match.bo.set`, `match.maps.set`, `match.score.set`,
  - persistence failures now return deterministic `setting_write_failed` and rollback runtime snapshot to pre-write state.
- Latest evidence for this scope:
  - pre-restart set/get baseline: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110802/` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110806/`,
  - full container restart with env overrides cleared + post-restart verification: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110852/` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110853/`,
  - plugin hot-restart verification: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-111100/` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-111102/`,
  - non-regression matrices: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-110902/summary.md` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110935/summary.md`.
- Incident memory (2026-02-22, persistence QA masked by env precedence):
  - symptom: BO/mode/duration persistence appeared inconsistent across restarts when container defaults were still exported.
  - root cause: runtime precedence is env-first; non-empty `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_*` values mask persisted settings during bootstrap checks.
  - fix: recreate `shootmania` with `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_BEST_OF=`, `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_MODE=`, and `PIXEL_CONTROL_VETO_DRAFT_MATCHMAKING_DURATION_SECONDS=` for persistence-focused QA runs.
  - validation: after restart, getters returned persisted series snapshot with `update_source=setting` and `updated_by=plugin_bootstrap`.

## Additional execution status (2026-02-22, veto countdown + threshold autostart + completion apply policy)
- Matchmaking veto countdown now emits deterministic markers and chat announcements from configured duration (`N, N-10, ..., 10, 5/4/3/2/1`), deduped per `<session_id, remaining_second>`.
- Matchmaking threshold auto-start is now configurable and persisted through `//pcveto min_players <int>` (`matchmaking_autostart_min_players` in `PixelControl.VetoDraft.Status`).
- Threshold auto-start gating uses connected human players (`PlayerManager::getPlayerCount(false, true)`), with anti-loop state markers: `armed`, `triggered`, `suppressed`, `below_threshold`.
- Completion map-order application is now branch-deterministic:
  - `opener_differs`: queue full order then apply `map.skip` to opener,
  - `opener_already_current`: queue remaining maps only, no opener restart/skip.
- Latest evidence for this scope:
  - veto status snapshot with threshold field: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-131059/status.json`,
  - veto matrix rerun: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-130832/summary.md`,
  - admin matrix rerun: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-130914/summary.md`,
  - runtime countdown/autostart/apply markers: `pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log`.
- Incident memory (2026-02-22, opener jump failure on completion path):
  - symptom: completion apply returned `map_skip_failed` while queue updates succeeded.
  - root cause: direct opener jump (`skipToMapByUid`) was not reliable in this runtime path for immediate post-veto transitions.
  - fix: switch opener-differs branch to deterministic `map.skip` after queueing opener-first order.
  - validation: runtime logs show `[PixelControl][veto][apply_success] ... branch=opener_differs ... skip_code=skip_applied` and opener-already-current branch shows `skip_code=skip_not_required`.
- Gotcha (2026-02-22, chat evidence capture):
  - ManiaControl runtime log does not reliably persist `sendInformation(...)` chat lines, so chat-text assertions (`Map vote IDs`, `Available veto IDs`, countdown chat text) should be validated with live client/chat capture or complementary observability markers.

## Additional execution status (2026-02-22, veto role visibility + status scoping + vote reset)
- Role-based veto map visibility is now enforced on chat/control surface:
  - non-admin map listings are index/name only,
  - admin listings keep UID-capable rows.
- Completion diagnostics are now admin-only:
  - `Series order`, `Completion branch`, and `Opener jump` are scoped to veto-control audience.
- `/pcveto status` visibility is now role-scoped:
  - non-admin sees veto-result projection only,
  - admin keeps operational diagnostics (`Map draft/veto status`, no-active-session guidance, vote/turn details, series config).
- Matchmaking countdown cadence now derives from configured duration and preserves per-session dedupe:
  - validated runtime example (`duration=15`) emitted `15,10,5,4,3,2,1` exactly once each in `pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log`.
- Matchmaking start now hard-resets vote counters for fresh sessions:
  - coordinator executes explicit `resetVoteCounters()` on session bootstrap and retains zero-baseline status snapshot.
- Evidence root for this execution: `pixel-sm-server/logs/qa/veto-role-visibility-countdown-reset/`.
  - required replays: `veto-payload-sim-20260222-135435/status.json`, `veto-payload-sim-20260222-135436/summary.md`, `admin-payload-sim-20260222-135454/summary.md`.
  - deterministic reset proof set: `veto-payload-sim-20260222-135328/`, `veto-payload-sim-20260222-135330/`, `veto-payload-sim-20260222-135333/`, `veto-payload-sim-20260222-135336/`, `veto-payload-sim-20260222-135338/`.
  - latest hot-sync validation logs: `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260222-140056.log` and `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260222-140056.log`.

## Additional execution status (2026-02-22, veto QA control-surface hardening)
- Veto matrix runtime flow is now modularized with one-file-per-step scripts in `pixel-sm-server/scripts/qa-veto-matrix-actions/` (`01..08`), consumed by `pixel-sm-server/scripts/qa-veto-payload-sim.sh matrix`.
- Veto matrix now emits strict machine-readable assertion artifacts:
  - `matrix-step-manifest.ndjson`,
  - `matrix-context.json`,
  - `matrix-validation.json` (required-check pass/fail source of truth).
- Automated suite veto required gates are now descriptor-driven through `pixel-sm-server/scripts/automated-suite/veto-checks/` (one check id per `.sh` file), similar to admin-action descriptors.
- Latest green evidence set for this hardening scope:
  - veto command checks: `veto-payload-sim-20260222-144529/` (`status.json`), `veto-payload-sim-20260222-144542/` (`start.json`), `veto-payload-sim-20260222-144558/` (`action.json`), `veto-payload-sim-20260222-144608/` (`cancel.json`),
  - veto matrix strict pass: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-144619/matrix-validation.json`,
  - admin matrix non-regression: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-144651/summary.md`,
  - automated suite full revalidation: `pixel-sm-server/logs/qa/automated-suite-20260222-144712/suite-summary.json` (`checks_total=39`, `passed=39`, `required_failures=0`).
- Hardening audit/index root: `pixel-sm-server/logs/qa/veto-control-surface-hardening-20260222-141438/` (`inventory.md`, `gap-analysis.md`, `evidence-index.md`).
- Contract note: this scope changed QA tooling/assertion coverage only; no additive/breaking communication contract change was introduced.
- Incident memory (2026-02-22, joust tournament compatibility false-negative in veto required checks):
  - symptom: `test-automated-suite.sh --modes elite,joust` failed required veto checks after matrix completion (`negative.tournament.actor_not_allowed` and tournament action-count assumptions) even though runtime flow completed.
  - root cause: in some joust/BO1 compatibility paths, tournament progression can expose a `system` step where forcing an invalid actor is not applicable and may consume expected action budget.
  - fix: make veto matrix + validator compatibility-aware for `system` turn ownership and gate invalid-actor assertions only when the scenario is applicable.
  - validation: rerun passed at `pixel-sm-server/logs/qa/veto-payload-sim-20260222-144619/matrix-validation.json` and `pixel-sm-server/logs/qa/automated-suite-20260222-144712/suite-summary.json`.

## Additional execution status (2026-02-22, matchmaking lifecycle closure hardening)
- Matchmaking post-veto lifecycle strict matrix is now green after runtime fallback adjustment:
  - veto matrix pass: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-170121/matrix-validation.json` (`overall_passed=true`, `required_failed_checks=[]`),
  - admin non-regression pass: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-170205/summary.md`.
- Evidence index for this scope: `pixel-sm-server/logs/qa/matchmaking-lifecycle-evidence-index-20260222.md`.
- Runtime behavior note: lifecycle closure can still converge via fallback inference even if selected-map trigger helper logs `Could not reach selected map uid before timeout hops`.
- Incident memory (2026-02-22, matchmaking lifecycle stuck at `veto_completed` during strict matrix):
  - symptom: `qa-veto-payload-sim.sh matrix` repeatedly failed required checks (`flow.matchmaking.lifecycle.sequence`, `flow.matchmaking.lifecycle.ready_state`) while status snapshots stayed `stage=veto_completed`.
  - root cause: `evaluateMatchmakingLifecycleRuntimeFallback()` returned early when current map UID was unavailable, which prevented timeout-based stage inference from progressing to `selected_map_loaded`/`match_started` in callback-sparse runtime windows.
  - fix: allow timeout-based match-start inference to run before the empty-current-map early return, then gate end-of-cycle finalization on known current-map UID; hot-sync plugin and rerun strict matrix.
  - validation: strict veto matrix passed at `pixel-sm-server/logs/qa/veto-payload-sim-20260222-170121/matrix-validation.json` with required lifecycle checks green.

## User preference (durable)
- For QA automation scripts, prefer modular Bash structure with one script per tested action/feature rather than large hardcoded lists inside monolithic scripts.
- Matrix replay order for admin actions now lives in `pixel-sm-server/scripts/qa-admin-matrix-actions/` (one sourced `.sh` step per action) and should remain the default extension point.
- Automated-suite required admin action catalog now lives in `pixel-sm-server/scripts/automated-suite/admin-actions/` (one `.sh` descriptor per action key) and should be updated whenever action coverage changes.
- After any plugin code modification request, run `bash pixel-sm-server/scripts/dev-plugin-hot-sync.sh` before reporting completion so runtime behavior matches source changes.
- When the user says `PLAN_EXECUTE`, treat it as explicit instruction to create a PLAN file with the `@planner` subagent and then execute that PLAN immediately with the `@executor` subagent.
