# Project Memory (Local AGENTS)

## Project overview
- Pixel Control is designed as a two-part system to orchestrate ManiaPlanet/ShootMania servers: a ManiaControl plugin per game server and a central API server.
- A third stream now exists: `pixel-sm-server/` as a first-party, easily deployable ShootMania dev server package (Docker-based) to test plugin behavior in real game conditions.
- Current repository state is still early-stage for full features, but first-party plugin and dev-server skeletons now exist and are ready for incremental implementation.
- Product direction confirmed with the user: plugin-first execution, multi-mode ShootMania support, local-first developer workflow, and `ressources/` used as reference only.

## Tech stack
- Plugin side (planned): PHP plugin on top of ManiaControl.
- Dev server infra (scaffolded in first-party `pixel-sm-server/`): Docker + Docker Compose around ManiaPlanet dedicated server + ManiaControl + MySQL.
- Platform dependencies: ManiaPlanet dedicated server XML-RPC + script callbacks, ManiaControl, MySQL.
- Optional ecosystem integration: ManiaPlanet Web Services OAuth2 (`ressources/oauth2-maniaplanet`).

## Repo layout
- `pixel-control-plugin/`: first-party ManiaControl plugin skeleton (`src/PixelControlPlugin.php`, callback registry, async API shell, queue/retry contracts).
- `pixel-sm-server/`: first-party Dockerized ShootMania dev stack baseline (`docker-compose.yml`, `Dockerfile`, `scripts/bootstrap.sh`, templates, `.env.example`).
- `.local-dev/`: gitignored local sandbox for mutable ManiaControl/ShootMania experiments outside first-party project trees.
- `ressources/ManiaControl/`: upstream ManiaControl code, runtime scripts, core/plugins, configs.
- `ressources/ManiaControl-Plugin-Examples/`: sample plugins to copy patterns from.
- `ressources/oauth2-maniaplanet/`: official PHP OAuth2 provider package.
- `ressources/maniaplanet-server-with-docker/`: imported dockerized ShootMania+ManiaControl reference stack.
- `ROADMAP.md`: canonical feature roadmap (when user says `ROADMAP`, this file is implied).

## Common commands
- Root checks:
  - `git rev-parse --show-toplevel`
  - `git status`
- First-party Pixel SM dev stack (from `pixel-sm-server`):
  - `cp .env.example .env`
  - `bash scripts/import-reference-runtime.sh` (optional, copies reference runtime into `pixel-sm-server/runtime/server`)
  - `docker compose up --build`
  - `docker compose down`
  - `docker compose logs -f`
  - `bash scripts/dev-plugin-sync.sh`
  - `bash scripts/replay-core-telemetry-wave3.sh`
  - `bash scripts/replay-extended-telemetry-wave4.sh`
  - `bash scripts/replay-admin-player-combat-telemetry.sh`
- ManiaControl sandbox workflow (copy reference first, then run from `.local-dev/`):
  - `mkdir -p .local-dev`
  - `cp -R ressources/ManiaControl .local-dev/maniacontrol`
  - `cp .local-dev/maniacontrol/configs/server.default.xml .local-dev/maniacontrol/configs/server.xml`
  - `php .local-dev/maniacontrol/ManiaControl.php` (foreground/debug)
- Dedicated server reference startup (from official docs):
  - `ManiaPlanetServer /nodaemon /dedicated_cfg=dedicated_cfg.txt /game_settings=MatchSettings/matchsettings.txt`
- Dockerized ShootMania reference stack (from `ressources/maniaplanet-server-with-docker`):
  - `docker compose up --build`
  - `docker compose down`
  - `docker compose logs -f`
- Reference tests (if phpunit is available in PATH):
  - `phpunit -c phpunittests/phpunit.xml` (from `.local-dev/maniacontrol`)

## Conventions
- Treat `ressources/` as immutable read-only reference code unless explicitly requested to edit it.
- Never run mutable workflows inside `ressources/` (no runtime launches, no log/pid generation, no config rewrites).
- Treat `pixel-sm-server/` and `pixel-control-plugin/` as separate first-party projects inside a monorepo.
- If reference assets are needed by a first-party project, copy/import them into that project directory first (do not bind mutable flows directly to `ressources/`).
- For local experimentation outside first-party projects, use `.local-dev/` (gitignored) as scratch workspace.
- If project-local imports need independent source tracking, initialize them as nested standalone repos inside the target project folder (empty git root + explicit import commit), never under `ressources/`.
- Build product code in `pixel-control-plugin/` and `pixel-sm-server/`.
- Build first-party dev server automation in `pixel-sm-server/` (do not evolve the imported Docker reference directly unless explicitly requested).
- Keep `API_CONTRACT.md` (repo root) updated whenever plugin->API route expectations change.
- Keep `pixel-control-plugin/README.md` updated whenever plugin capabilities or operator workflows change.
- For plugin implementation, follow ManiaControl plugin contract conventions:
  - implement `ManiaControl\Plugins\Plugin` methods (`prepare`, `load`, `unload`, metadata getters),
  - wire callbacks/commands via managers,
  - keep settings centralized via `SettingManager`.
- Keep plugin/server contract explicit and versioned (payload schema, idempotency keys, retries, compatibility matrix).
- Multi-mode support is required (do not hardcode Elite-only architecture).
- Authentication choice between plugin and server is not fixed yet; document options in `ROADMAP.md` before locking implementation.
- For Docker/dev-server work, document env var names only (no secret values) and keep secure defaults in `.env.example` style templates.
- After each resolved blocker, append a concise incident memory in this local `AGENTS.md` with: symptom, root cause, applied fix, and validation signal so future runs avoid repeating the same failure.

## CI / release
- No CI workflow files found at repo root (`.github/workflows` absent, `.gitlab-ci.yml` absent).
- No release/versioning process defined yet for first-party Pixel Control code.

## Gotchas
- `pixel-sm-server/` now has a first-party baseline, but still requires local runtime assets in `pixel-sm-server/runtime/server/` (dedicated binary + ManiaControl runtime).
- `PIXEL_SM_RUNTIME_SOURCE` and title pack mutable sources must stay outside `ressources/`; helper scripts now fail fast when pointed at reference paths.
- ManiaControl requires valid server + MySQL credentials in `ressources/ManiaControl/configs/server.xml`; never commit credentials.
- `ressources/maniaplanet-server-with-docker/docker-compose.yml` and related XML files include hardcoded credentials; treat them as insecure samples and rotate/rewrite before any real deployment.
- ManiaPlanet XML-RPC port (default 5000) is sensitive and should stay private.
- The imported Docker stack uses `network_mode: host`; published `ports:` are ignored in host mode and Docker Desktop host networking must be enabled (Desktop 4.34+).
- In the imported Dockerfile, `TITLE_PACK` is configurable but `/game_settings` is hardcoded to `MatchSettings/.txt`; multi-mode support needs explicit matchsettings parametrization.
- `ressources/maniaplanet-server-with-docker/TitlePacks/` is not copied by the current Dockerfile (`COPY server .` only), so custom title packs are not auto-included yet.
- `https://www.maniacontrol.com` currently returns an expired certificate in this environment; prefer official docs and GitHub mirrors for references.
- `google_search` tool may return account-validation 403 in this environment; use direct `webfetch` URLs as fallback for web research.
- ManiaControl in the imported runtime crashes on PHP 8.x (`libs/curl-easy/cURL/RequestsQueue.php` Countable signature + AsyncHttpRequest fatal); keep first-party `pixel-sm-server/Dockerfile` on Ubuntu 20.04/PHP 7.4 unless compatibility is explicitly addressed.
- Matchsettings templates without explicit `<map>` entries can trigger `ERROR: Empty playlist`; first-party bootstrap now injects available runtime `.Map.Gbx` entries into `active-matchsettings.txt` to fail-safe local launches.
- Runtime map auto-injection is now restricted to Elite-compatible flows; for Siege/Battle/Joust/Royal scripts, bootstrap fails early with explicit map guidance when `<map>` entries are missing.
- Battle mode in current workflow expects `SMStormBattle@nadeolabs` + `Battle\BattlePro.Script.txt`; using `ShootMania\Battle\Mode.Script.txt` fails in this runtime.
- Official battle title pack download endpoint: `https://maniaplanet.com/ingame/public/titles/download/SMStormBattle@nadeolabs.Title.Pack.gbx`.
- Admin payload control surface currently allows unauthenticated actorless execution (`PixelControl.Admin.ExecuteAction` in temporary trusted mode); before production exposure, implement source authentication (for example HMAC/JWT + timestamp/nonce replay protection) and restrict accepted origins.

## Plugin implementation playbook
- Startup order: `ManiaControl::run()` triggers `Callbacks::ONINIT`, then plugin loading (`PluginManager::loadPlugins()`), then `Callbacks::AFTERINIT`.
- Script callbacks are enabled during connection (`connect()` -> `Server::getScriptManager()->enableScriptCallbacks()`), before plugin load.
- Plugin class requirements: implement `ManiaControl\Plugins\Plugin`, keep file basename equal to class basename, and return `getId() > 0` (unless `DEV_MODE` is enabled).
- Automatic cleanup on unload only applies to implemented listener interfaces (`CallbackListener`, `CommandListener`, `TimerListener`, `ManialinkPageAnswerListener`, `SidebarMenuEntryListener`, `CommunicationListener`, `EchoListener`).
- For typed ShootMania events, use `registerCallbackListener(Callbacks::SM_*, ...)`; this yields typed structures via `ShootManiaCallbacks`.
- Use `registerScriptCallbackListener(...)` only when raw script callback payloads are explicitly needed.
- Keep callback handlers lightweight: ManiaControl loop targets a tight tick (`~2.5ms` sleep budget), so heavy work should be buffered and flushed on timers.
- Prefer async outbound HTTP (`AsyncHttpRequest`) and keep retry/idempotency logic in Pixel Control plugin code, not in callback hot-paths.

## Callback shortlist for Pixel Control P0
- Lifecycle: `CallbackManager::CB_MP_BEGINMATCH`, `CB_MP_ENDMATCH`, `CB_MP_BEGINMAP`, `CB_MP_ENDMAP`, `CB_MP_BEGINROUND`, `CB_MP_ENDROUND`.
- Player state: `PlayerManager::CB_PLAYERCONNECT`, `CB_PLAYERDISCONNECT`, `CB_PLAYERINFOCHANGED`, `CB_PLAYERINFOSCHANGED`.
- Combat/stats: `Callbacks::SM_ONSHOOT`, `SM_ONHIT`, `SM_ONNEARMISS`, `SM_ONARMOREMPTY`, `SM_ONCAPTURE`, `SM_SCORES`.
- Mode-specific extensions: `Callbacks::SM_ELITE_STARTTURN`, `SM_ELITE_ENDTURN`, `SM_JOUST_*`, `SM_ROYAL_*`.
- Useful payload details from typed structures: weapon IDs (`Laser=1`, `Rocket=2`, `Nucleus=3`, `Arrow=5`), damage/distance, shooter/victim positions, capture players and score snapshots.

## Pixel SM server implementation notes
- Reference Docker image copies only `server/` (`COPY server .`), so `TitlePacks/` are missing unless explicitly copied or mounted.
- Reference startup command hardcodes `/game_settings=MatchSettings/.txt`; first-party stack must parameterize matchsettings to unlock multi-mode support.
- First-party networking profiles: bridge-default in `pixel-sm-server/docker-compose.yml`, optional host override in `pixel-sm-server/docker-compose.host.yml`.
- With `network_mode: host`, published `ports:` are ignored; host profile also requires Docker Desktop host networking support (Desktop 4.34+) and free host ports.
- Treat all credentials in imported samples as insecure placeholders and replace them with `.env.example`-style variables only.
- First-party compose now wires `shootmania` healthcheck to `scripts/healthcheck.sh` (DB ping + plugin load marker + XML-RPC TCP probe); keep smoke checks aligned with this readiness contract.
- Mode map pool is mounted via `PIXEL_SM_MAPS_SOURCE` and synced into runtime `UserData/Maps/PixelControl/` at bootstrap.
- Mode matrix smoke helper: `pixel-sm-server/scripts/qa-mode-smoke.sh` validates Elite + Siege + Battle flows.
- Wave-2 replay helper: `pixel-sm-server/scripts/qa-admin-stats-replay.sh` posts deterministic admin/player/combat envelopes into local server ingestion; treat as legacy while backend runtime remains paused.
- Wave-2 replay helper fails fast with `curl: (7)` when backend ingestion is not running on `127.0.0.1:8080`; keep this expected while backend runtime remains paused.
- Wave-3 replay helper: `pixel-sm-server/scripts/qa-wave3-telemetry-replay.sh` runs a local ACK stub, starts the stack with deterministic QA ports, replays admin/player/map actions in-container, validates required telemetry markers, and stores artifacts under `pixel-sm-server/logs/qa/wave3-telemetry-<timestamp>-*`.
- Wave-3 helper now supports deterministic marker fixtures (`PIXEL_SM_QA_TELEMETRY_INJECT_FIXTURES=1` by default) and host-side stub posting through `PIXEL_SM_QA_TELEMETRY_STUB_LOCAL_URL` (default `http://127.0.0.1:18080`) to avoid local `host.docker.internal` DNS issues.
- Wave-4 replay helper: `pixel-sm-server/scripts/qa-wave4-telemetry-replay.sh` validates reconnect/side-change/team-aggregate/win-context/veto markers, stores artifacts under `pixel-sm-server/logs/qa/wave4-telemetry-<timestamp>-*`, and indexes canonical evidence in `pixel-sm-server/logs/qa/wave4-evidence-index-20260220.md`.
- Admin payload simulation helper: `pixel-sm-server/scripts/qa-admin-payload-sim.sh` simulates future server-originated `PixelControl.Admin.ListActions`/`PixelControl.Admin.ExecuteAction` payloads over ManiaControl communication socket and stores artifacts under `pixel-sm-server/logs/qa/admin-payload-sim-<timestamp>/`.
- Admin payload simulation helper now supports `PIXEL_SM_ADMIN_SIM_OUTPUT_ROOT` to force run-local artifact roots while preserving default output behavior.
- Automated orchestration helper is now first-party: `pixel-sm-server/scripts/test-automated-suite.sh`.
- Orchestrator defaults to `--modes elite,joust`, supports `--modes <csv>` and optional `--with-mode-smoke`, and writes deterministic run artifacts under `pixel-sm-server/logs/qa/automated-suite-<timestamp>/` (`run-manifest.json`, `coverage-inventory.json`, `check-results.ndjson`, `suite-summary.json`, `suite-summary.md`, `manual-handoff.md`).
- Orchestrator required coverage includes per-mode launch smoke + wave-4 plugin-only marker validation, admin response/payload/correlation assertions, and strict elite gate (`qa-wave3-telemetry-replay.sh` + strict `qa-wave4-telemetry-replay.sh`); it exits non-zero on required check failures.
- Automated suite keeps live combat callbacks manual-only (`OnShoot`, `OnHit`, `OnNearMiss`, `OnArmorEmpty`, `OnCapture`) and routes that boundary to `manual-handoff.md`.
- In current battle-mode runtime, direct fake-player `forcePlayerTeam(...)` calls can intermittently return `UnknownPlayer`; wave-4 replay now treats those as non-fatal warnings and relies on deterministic fixture envelopes for required marker closure.
- Wave-5 manual evidence helpers are now first-party: `pixel-sm-server/scripts/manual-wave5-session-bootstrap.sh`, `pixel-sm-server/scripts/manual-wave5-ack-stub.sh`, `pixel-sm-server/scripts/manual-wave5-log-export.sh`, and `pixel-sm-server/scripts/manual-wave5-evidence-check.sh`.
- Recommended manual payload capture flow: run local ACK stub on host `127.0.0.1:18080`, then restart plugin transport with `PIXEL_CONTROL_API_BASE_URL=http://host.docker.internal:18080 bash scripts/dev-plugin-sync.sh` before real-client scenarios.
- QA launch smoke supports multi-file compose selection through `PIXEL_SM_QA_COMPOSE_FILES` (CSV, default `docker-compose.yml`).
- Plugin fast-sync helper (`pixel-sm-server/scripts/dev-plugin-sync.sh`) supports multi-file compose selection through `PIXEL_SM_DEV_COMPOSE_FILES` (CSV, default `docker-compose.yml`) and leaves stack running for iteration.
- Plugin hot-sync helper (`pixel-sm-server/scripts/dev-plugin-hot-sync.sh`) now supports plugin-only refresh without shootmania container restart: it copies plugin source into runtime and restarts ManiaControl process only (dedicated server PID should remain unchanged).
- Plugin transport runtime now also supports queue/dispatch/heartbeat knobs through `PIXEL_CONTROL_QUEUE_MAX_SIZE`, `PIXEL_CONTROL_DISPATCH_BATCH_SIZE`, and `PIXEL_CONTROL_HEARTBEAT_INTERVAL_SECONDS`.
- In bridge-network local dev, ManiaControl communication socket may fail if it binds to external published IP; for reliable plugin communication-method QA, ensure runtime `CommunicationManager` listens on `0.0.0.0` (runtime compatibility patch currently applied in `pixel-sm-server/runtime/server/ManiaControl/core/Communication/CommunicationManager.php`).
- If default local ports are occupied during dev fast sync, override runtime ports inline (for example `PIXEL_SM_XMLRPC_PORT=57000 PIXEL_SM_GAME_PORT=57100 PIXEL_SM_P2P_PORT=57200 bash scripts/dev-plugin-sync.sh`).
- For LAN peer-play sessions where login-based join URLs resolve to public IP and fail/hang, use local server list join and, if needed, restart with legacy gameplay ports (`PIXEL_SM_GAME_PORT=2350 PIXEL_SM_P2P_PORT=3450`) for compatibility.
- LAN local-server-list discovery is now considered stable on native gameplay ports; keep `.env` defaults on `PIXEL_SM_GAME_PORT=2350` and `PIXEL_SM_P2P_PORT=3450` unless a session explicitly needs temporary overrides.
- Incident memory (2026-02-20, server not visible/reachable on LAN):
  - symptom: server missing from local list or join failures/hangs while using non-native gameplay ports.
  - root cause: gameplay ports were moved away from native defaults and login URL resolution could route to public IP path.
  - fix: pin gameplay ports back to native values (`PIXEL_SM_GAME_PORT=2350`, `PIXEL_SM_P2P_PORT=3450`) and join through local server list.
  - validation: server appears in local list and remote client reaches spawn successfully.
- Host-side direct XML-RPC clients against published port can be reset by server access policy; reliable automation is to run dedicated API calls from inside the `shootmania` container using ManiaControl's bundled PHP client (`Maniaplanet\DedicatedServer\Connection::factory('127.0.0.1', $PIXEL_SM_XMLRPC_PORT, ...)`).
- For plugin payload evidence capture, a local ACK stub on host port `18080` works with container target `host.docker.internal:18080`; writing raw envelopes as NDJSON in `pixel-sm-server/logs/dev/` enables deterministic inspection of emitted payload fields.
- Outage/recovery QA is reproducible by toggling that local ACK stub: stop stub -> observe `outage_entered`/`retry_scheduled` markers; restart stub -> observe `outage_recovered` + `recovery_flush_complete` in `pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log`.
- Incident memory (2026-02-21, repeated `retry_scheduled` spam for `host.docker.internal:18080`):
  - symptom: ManiaControl log repeatedly emitted `[PixelControl][queue][retry_scheduled] ... Failed to connect to host.docker.internal port 18080: Connection refused`.
  - root cause: plugin transport target (`PIXEL_CONTROL_API_BASE_URL=http://host.docker.internal:18080`) was configured, but no ACK/backend listener was running on host port `18080`.
  - fix: start local ACK stub (`bash pixel-sm-server/scripts/manual-wave5-ack-stub.sh --output pixel-sm-server/logs/dev/live-ack-stub.ndjson`) so plugin retries can recover and flush.
  - validation: `ManiaControl.log` showed `outage_recovered` then `recovery_flush_complete`, and repeated retry warnings stopped.
- `connectFakePlayer` + forced map transitions (`restartMap`/`nextMap`) can trigger admin-flow callbacks and at least `OnScores` combat envelope shape validation, but real client gameplay is still required for non-zero shot/hit/miss/kill counters.
- Manual combat observability logs are now emitted with prefix `[Pixel Plugin]` for `OnShoot`/`OnHit`/`OnNearMiss`/`OnArmorEmpty`/`OnCapture`/`OnScores`; monitor with `tail -f pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log | grep --line-buffered -E '\[Pixel Plugin\]'`.
- Incident memory (2026-02-20, long-lived in-memory combat stats retention):
  - symptom: concern that combat counters persisted in plugin memory for the full server uptime and could accumulate unnecessary player rows.
  - root cause: `PlayerCombatStatsStore` was runtime-only but reset only on plugin reload/restart, so retention window matched long-lived process lifetime.
  - fix: reset combat counter store + aggregate baselines on `match.begin` and `map.begin` lifecycle boundaries to keep retention bounded to active match/map windows.
  - validation: `MatchDomainTrait::buildLifecycleAggregateTelemetry()` now calls reset helper on `match.begin|map.begin`, and `FEATURES.md`/`docs/event-contract.md` describe bounded non-persistent retention.
- Incident memory (2026-02-20, communication socket bind failure in containerized QA):
  - symptom: `CommunicationManager` raised `Could not bind to tcp://<public-ip>:31501: Cannot assign requested address`, and plugin communication methods were unavailable.
  - root cause: runtime `CommunicationManager` attempted to bind the socket to `ManiaControl->server->ip` (external published IP not present inside bridge container network).
  - fix: bind communication socket to `0.0.0.0` in runtime `CommunicationManager` and restart stack.
  - validation: ManiaControl log now shows `Socket 0.0.0.0:31501 Successfully created!`, and `PixelControl.Admin.ListActions` returns delegated action catalog over communication socket.
- Incident memory (2026-02-20, wave-4 strict replay produced empty capture):
  - symptom: `qa-wave4-telemetry-replay.sh` failed strict marker validation with zero captured envelopes.
  - root cause: local ACK stub port `18080` was already occupied by another stub session, so replay capture file remained empty for that run.
  - fix: stop conflicting stub session before replay and rerun strict wave-4 replay.
  - validation: strict replay passed with marker closure in `pixel-sm-server/logs/qa/wave4-telemetry-20260220-193214-markers.json`.
- Incident memory (2026-02-21, external admin payload actor requirements):
  - symptom: server-originated `PixelControl.Admin.ExecuteAction` calls required `actor_login` and returned `actor_not_found` when omitted, blocking actorless server orchestration.
  - root cause: delegated action flow always resolved a connected actor and always applied plugin permission checks before gateway execution.
  - fix: communication-path execution now enables actorless mode (`allow_actorless`) and skips plugin permission checks in temporary trusted mode (`security_mode=payload_untrusted`); gateway supports actorless force/auth flows using native ManiaControl APIs.
  - validation: PHP lint passes on `AdminControlDomainTrait`/`NativeAdminGateway`, docs updated in `pixel-control-plugin/docs/admin-capability-delegation.md`, `pixel-control-plugin/docs/event-contract.md`, and `API_CONTRACT.md`.
- Incident memory (2026-02-21, pause.end had no visible gameplay effect in delegated admin flow):
  - symptom: `pause.start` could pause gameplay, but `pause.end` returned success without resuming match state in some mode/script combinations.
  - root cause: pause delegation relied on pause events/partial commands and did not consistently unwind warmup/round-forcing side effects across script implementations.
  - fix: `NativeAdminGateway::applyPauseState(false)` now uses a broader compatibility sequence (`Command_SetPause=false`, `Command_ForceWarmUp=false`, `Command_ForceEndRound=false`, plus `ModeScriptEventManager::endPause()` and `stopManiaPlanetWarmup()` fallback).
  - validation: PHP lint passes, plugin hot-sync completed, and delegated `pause.start`/`pause.end` payload calls return success with compatibility marker `script_event_plus_mode_commands`.
- Incident memory (2026-02-21, Elite turn callbacks missing lifecycle round telemetry):
  - symptom: manual Elite gameplay produced `OnEliteStartTurn`/`OnEliteEndTurn` mode events and `scores_section=EndTurn`, but no lifecycle `round.begin`/`round.end` envelopes.
  - root cause: lifecycle normalization mapped only ManiaPlanet round callbacks; Elite turn callbacks were emitted only under `mode` category.
  - fix: mode handler now projects Elite turn callbacks into lifecycle enqueue path, and lifecycle variant resolver maps Elite start/end turn callback identifiers to `round.begin`/`round.end`.
  - validation: PHP lint passes on `CoreDomainTrait`/`LifecycleDomainTrait`, docs updated in `FEATURES.md`, `docs/event-contract.md`, `docs/schema/event-name-catalog-2026-02-20.1.json`, and `docs/manual-feature-test-todo.md`.
- Incident memory (2026-02-21, player callbacks emitted `player.unknown` instead of `player.connect`/`player.disconnect`):
  - symptom: manual NDJSON capture showed `event_name=pixel_control.player.maniacontrol_players_player` and `payload.event_kind=player.unknown` even when connectivity delta clearly indicated connect/disconnect transitions.
  - root cause: queue extraction used callback argument shape (`ManiaControl\Players\Player` object) as source callback; ManiaControl dispatch does not pass callback name to listener params, so transition mapping never saw `PlayerManagerCallback.*` identifiers.
  - fix: player pipeline now resolves a semantic player source callback before envelope creation (`CB_PLAYERCONNECT`/`CB_PLAYERDISCONNECT`/`CB_PLAYERINFOCHANGED`/`CB_PLAYERINFOSCHANGED`) using callback args + cached connectivity transitions; player argument extraction now scans all args instead of only the first.
  - validation: PHP lint passes on `PipelineDomainTrait` and `PlayerDomainTrait`; next runtime reconnect should emit `payload.event_kind=player.connect|player.disconnect|player.info_changed|player.infos_changed` with normalized `event_name` matching `PlayerManagerCallback.*`.
- Incident memory (2026-02-21, admin player actions missing `admin_correlation` on player events):
  - symptom: after `player.force_team` test, player telemetry showed `state_delta.team_id.changed=true` but `payload.admin_correlation.correlated` stayed false.
  - root cause: admin-correlation cache (`recentAdminActionContexts`) was populated from lifecycle enqueue path only; direct admin execute path did not seed context for player-targeted actions, so player-domain correlation could not match recent admin intent.
  - fix: `AdminControlDomainTrait::executeDelegatedAdminAction()` now records correlation context on successful admin execution (action name/type/target scope/target id/initiator/actor/observed_at) via `rememberAdminActionCorrelationContext(...)`.
  - validation: runtime plugin source contains the new correlation helper methods in `Domain/Admin/AdminControlDomainTrait.php`; QA checklist now states precondition that positive correlation checks require admin action response `success=true`.
- Incident memory (2026-02-21, orchestrator preflight incorrectly rejected readable scripts):
  - symptom: `test-automated-suite.sh` failed immediately with `Missing executable script: .../qa-mode-smoke.sh` before any QA checks ran.
  - root cause: preflight used `-x` checks even though helper scripts are invoked via `bash <script>` and may intentionally be non-executable in git metadata.
  - fix: preflight now validates script presence (`-f`) instead of executable bit.
  - validation: default orchestrator run completed to full check execution and produced passing summary at `pixel-sm-server/logs/qa/automated-suite-20260221-212244/suite-summary.json`.
- Incident memory (2026-02-21, admin response/payload correlation false negatives in automated suite):
  - symptom: correlation checks failed although admin payload capture succeeded, because successful actions like `map.skip`/`map.restart` had no deterministic matching `admin_action.action_name` in captured envelopes.
  - root cause: correlation required every successful admin action from response matrix, but captured payload stream only guarantees deterministic lifecycle/system-facing action names for a subset in this environment.
  - fix: correlation now targets an explicit deterministic allowlist (`warmup.extend`, `warmup.end`, `pause.end`) and supports alias matching (`warmup.status`, `pause.end`) for script-generated lifecycle envelopes.
  - validation: full default run passed with `overall_status=passed` at `pixel-sm-server/logs/qa/automated-suite-20260221-212244/suite-summary.json`, elite-only rerun passed at `pixel-sm-server/logs/qa/automated-suite-20260221-213008/suite-summary.json`, and final full default re-validation passed with `checks_total=31`/`passed=31` at `pixel-sm-server/logs/qa/automated-suite-20260221-214203/suite-summary.json`.

## Current execution status (2026-02-20)
- Active execution direction: plugin-first and dev-server-first; backend/API implementation is paused by user for now.
- Plugin schema baseline remains `2026-02-20.1`; wave-5 keeps version unchanged and continues additive optional fields only.
- Native-admin delegation refactor plan (`PLAN-maniacontrol-native-admin-delegation-refactor.md`) is now complete through phase 6:
  - plugin control surface delegates map/warmup/pause/vote/player/auth execution to ManiaControl native services,
  - permission model enforced through native plugin rights,
  - rollout safety/rollback procedure documented,
  - docs synchronized in `pixel-control-plugin/FEATURES.md`, `pixel-control-plugin/docs/event-contract.md`, `pixel-control-plugin/docs/admin-capability-delegation.md`, and `API_CONTRACT.md` note.
- Admin delegation QA evidence set is captured in `pixel-sm-server/logs/qa/admin-delegation-20260220-1926/` (action matrix, permission matrix, non-Elite fallback, telemetry regression summary, acceptance summary).
- Wave-5 plugin hardening delivered:
  - deterministic identity validation on enqueue/dispatch (`drop_identity_invalid` warning + queue counter `dropped_on_identity_validation`),
  - additive player constraint telemetry (`constraint_signals`) for forced-team/slot-policy context with deterministic availability/fallback reasons,
  - callback hot-path safety via dedicated-policy cache refresh on load/heartbeat and cached reads in player callbacks.
- Wave-5 deterministic QA indexing is complete:
  - canonical index: `pixel-sm-server/logs/qa/wave5-evidence-index-20260220.md`,
  - strict replay closure artifact set: `pixel-sm-server/logs/qa/wave4-telemetry-20260220-143317-*`,
  - fixture-off plugin-only baseline artifact set: `pixel-sm-server/logs/qa/wave4-telemetry-20260220-143433-*`,
  - fixture-off pre-profile strict failure retained for traceability: `pixel-sm-server/logs/qa/wave4-telemetry-20260220-143020-*`.
- Wave-5 manual evidence contract is standardized:
  - canonical directory: `pixel-sm-server/logs/manual/wave5-real-client-20260220/`,
  - matrix file: `pixel-sm-server/logs/manual/wave5-real-client-20260220/MANUAL-TEST-MATRIX.md` (`W5-M01..W5-M10`),
  - required per-session templates: `SESSION-<id>-{notes.md,payload.ndjson,evidence.md}`,
  - index + completeness checker flow: `INDEX.md` + `bash scripts/manual-wave5-evidence-check.sh --manual-dir ...` (now requires matrix presence).
- Final wave-5 handoff artifact is published: `HANDOFF-autonomous-wave-5-2026-02-20.md`.
- Wave-1 manual gameplay closure remains pending by user choice:
  - user said manual gameplay tests will be run later,
  - keep `PLAN-autonomous-execution-wave-1.md` manual `P7.2/P7.3` evidence closure pending until user provides gameplay captures.
- Wave-4/wave-5 real-client gameplay validation remains pending for plugin-only evidence (non-fixture reconnect/side-change/veto actor behavior under real player flow).
- Where we stopped: wave-5 core work + native-admin delegation refactor are complete; remaining open validation is user-run real-client gameplay/evidence closure.
- Map draft/veto implementation (2026-02-21) is now added to plugin-first codebase:
  - feature subtree: `pixel-control-plugin/src/VetoDraft/` (`VetoDraftCatalog`, `MapPoolService`, `MatchmakingVoteSession`, `TournamentSequenceBuilder`, `TournamentDraftSession`, `VetoDraftCoordinator`, `VetoDraftQueueApplier`),
  - integration trait: `pixel-control-plugin/src/Domain/VetoDraft/VetoDraftDomainTrait.php`, wired through `PixelControlPlugin` + `CoreDomainTrait` periodic timer,
  - command surface: `/pcveto ...` and `//pcveto ...` (dual command-channel registration so both user and admin chat prefixes route to veto handler; control/override rights enforced for privileged operations),
  - runtime defaults are now admin-configurable through chat (`//pcveto mode <matchmaking|tournament>`, `//pcveto duration <seconds>`),
  - player-first matchmaking flow now auto-starts configured `matchmaking_vote` on first `vote` request when no active session exists (tournament auto-start intentionally out-of-scope in this phase),
  - chat observability now emits explicit launch marker (`Matchmaking veto launched ...`) and explicit queued map list (`Queued maps:`) after queue apply,
  - communication methods: `PixelControl.VetoDraft.Start`, `PixelControl.VetoDraft.Action`, `PixelControl.VetoDraft.Status`, `PixelControl.VetoDraft.Cancel`,
  - lifecycle map telemetry now exposes authoritative veto state through `map_rotation.veto_draft_mode`, `map_rotation.veto_draft_session_status`, `veto_draft_actions`, and `veto_result`.
- Draft/veto runtime settings now available (env + setting equivalents):
  - `PIXEL_CONTROL_VETO_DRAFT_ENABLED`,
  - `PIXEL_CONTROL_VETO_DRAFT_COMMAND`,
  - `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_MODE`,
  - `PIXEL_CONTROL_VETO_DRAFT_MATCHMAKING_DURATION_SECONDS`,
  - `PIXEL_CONTROL_VETO_DRAFT_TOURNAMENT_ACTION_TIMEOUT_SECONDS`,
  - `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_BEST_OF`,
  - `PIXEL_CONTROL_VETO_DRAFT_LAUNCH_IMMEDIATELY`.
- Elite veto test pool now includes 9 curated Elite maps under `pixel-sm-server/maps/elite/` and Elite matchsettings references only those entries in `pixel-sm-server/templates/matchsettings/elite.txt`.
- Deterministic QA evidence for this feature is stored at `pixel-sm-server/logs/qa/map-draft-veto-20260221-executor/` (`qa-summary.md` + `acceptance-checklist.md`).
- Server-orchestrated veto simulation helper is now first-party: `pixel-sm-server/scripts/qa-veto-payload-sim.sh` (commands: `status`, `start`, `action`, `cancel`, `matrix`).
- Veto payload simulation evidence is captured under `pixel-sm-server/logs/qa/veto-payload-sim-<timestamp>/` (latest successful dynamic-turn run: `veto-payload-sim-20260221-223726/summary.md`).
- Queue application now follows a DIP-friendly runtime adapter boundary (`MapRuntimeAdapterInterface` + `ManiaControlMapRuntimeAdapter`), enabling deterministic adapter-level smoke validation without booting full ManiaControl runtime.
- Live container/runtime map-application validation remains recommended before production rollout even though logic-level queue behavior is smoke-validated (`veto_draft_queue_apply_smoke_ok`).
- Incident memory (2026-02-21, `//pcveto maps` no-op in chat):
  - symptom: admin chat prefix command `//pcveto maps` produced no visible veto handler response.
  - root cause: veto command listener was only registered on non-admin command channel; ManiaControl routes `//` messages through admin command listeners.
  - fix: register veto command on both command channels (`adminCommand=false` and `adminCommand=true`) in `VetoDraftDomainTrait`.
  - validation: PHP lint passes on plugin trait; runtime payload/status checks still report command `pcveto` enabled; matrix payload flow remains green.
- Incident memory (2026-02-21, static tournament actor matrix produced false-negative step):
  - symptom: first `qa-veto-payload-sim.sh matrix` run reported one `actor_not_allowed` tournament action despite healthy session progression.
  - root cause: matrix used static actor sequence that could desync from runtime `current_step.team` turn owner.
  - fix: matrix tournament loop now reads live status snapshot each turn and selects actor dynamically from `current_step.team` before sending action payload.
  - validation: rerun `veto-payload-sim-20260221-223726/summary.md` shows all tournament action steps `success=true` with no `actor_not_allowed` rows.
- Incident memory (2026-02-21, draft timeout smoke expectation mismatch):
  - symptom: timeout smoke scenario failed with `timeout event missing`.
  - root cause: tournament session enforces minimum timeout floor of 10 seconds; test used 1-second assumption with insufficient elapsed delta.
  - fix: adjust smoke ticks to exceed enforced minimum timeout and re-run scenario.
  - validation: corrected smoke run output `veto_draft_extended_smoke_ok`.
- Incident memory (2026-02-21, BO1 completion expectation mismatch):
  - symptom: BO1 smoke check failed with `bo1 map count mismatch` after partial actions.
  - root cause: BO1 sequence still requires full ban timeline (`map_pool_size - 1` bans) before automatic decider lock.
  - fix: complete full BO1 ban sequence (or equivalent timeout progression) before asserting final series map order.
  - validation: corrected smoke run completed with one-map series order and output `veto_draft_extended_smoke_ok`.

## Additional execution status (2026-02-21, BO/maps/score controls)
- Series policy controls are now first-party in plugin runtime:
  - state owner: `pixel-control-plugin/src/SeriesControl/SeriesControlState.php` (+ catalog/interface),
  - runtime fields: `best_of`, `maps_score.team_a|team_b`, `current_map_score.team_a|team_b`, metadata (`updated_at`, `updated_by`, `update_source`).
- Chat/admin surfaces now support series policy operations:
  - `//pcveto config` prints runtime series snapshot (BO write removed from `pcveto`; use `pcadmin` actions),
  - `//pcadmin match.bo.set best_of=<odd>`,
  - `//pcadmin match.bo.get`,
  - `//pcadmin match.maps.set target_team=<0|1|red|blue> maps_score=<int>`,
  - `//pcadmin match.maps.get`,
  - `//pcadmin match.score.set target_team=<0|1|red|blue> score=<int>`,
  - `//pcadmin match.score.get`.
- Communication/admin surfaces now include additive series controls:
  - delegated actions: `match.bo.set`, `match.bo.get`, `match.maps.set`, `match.maps.get`, `match.score.set`, `match.score.get` via `PixelControl.Admin.ExecuteAction`,
  - additive `series_targets` snapshots in `PixelControl.Admin.ListActions` and `PixelControl.VetoDraft.Status`,
  - lifecycle `map_rotation` telemetry now includes additive `series_targets` snapshot.
- BO precedence contract is explicit in runtime:
  - tournament start honors explicit request `best_of` first,
  - omitted `best_of` falls back to runtime series-policy default.
- Deterministic evidence captured for this scope:
  - admin matrix: `pixel-sm-server/logs/qa/admin-payload-sim-20260221-231000/summary.md`,
  - veto matrix: `pixel-sm-server/logs/qa/veto-payload-sim-20260221-231032/summary.md`,
  - series set/status checks: `pixel-sm-server/logs/qa/admin-payload-sim-20260221-231222/execute-match-series-set.json`, `pixel-sm-server/logs/qa/admin-payload-sim-20260221-231231/execute-match-series-status.json`,
  - BO-default fallback check (`best_of=7` without explicit start parameter): `pixel-sm-server/logs/qa/veto-payload-sim-20260221-231335/start.json`.
- Fresh revalidation evidence (2026-02-22):
  - admin matrix rerun summary: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-004714/summary.md`.
  - veto matrix rerun summary: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-004758/summary.md`.
- Incident memory (2026-02-21, QA veto matrix precondition failure):
  - symptom: `qa-veto-payload-sim.sh matrix` failed immediately with `Service 'shootmania' is not running`.
  - root cause: local compose stack was not running when simulation started.
  - fix: start stack from `pixel-sm-server` using `docker compose up -d --build`, then rerun simulation.
  - validation: rerun completed successfully with summary at `pixel-sm-server/logs/qa/veto-payload-sim-20260221-231032/summary.md`.
- Incident memory (2026-02-22, QA admin matrix precondition failure):
  - symptom: `qa-admin-payload-sim.sh matrix` failed immediately with `Service 'shootmania' is not running`.
  - root cause: local compose stack was down before communication-matrix replay started.
  - fix: start stack from `pixel-sm-server` using `docker compose up -d --build`, then rerun admin matrix.
  - validation: rerun completed successfully with summary at `pixel-sm-server/logs/qa/admin-payload-sim-20260222-004714/summary.md`.
- Automated suite hardening closure (2026-02-22):
  - final green orchestrator evidence: `pixel-sm-server/logs/qa/automated-suite-20260222-003125/` (`suite-summary.json`, `suite-summary.md`, `check-results.ndjson`) with `checks_total=39`, `passed=39`, `required_failures=0`.
  - latest execution revalidation evidence: `pixel-sm-server/logs/qa/automated-suite-20260222-094958/` (`suite-summary.json`, `suite-summary.md`, `check-results.ndjson`, `manual-handoff.md`) with `checks_total=39`, `passed=39`, `required_failures=0`.
- Incident memory (2026-02-22, false-positive suite failures from recovery races in automated veto checks):
  - symptom: `test-automated-suite.sh` intermittently failed `mode.*.veto.matrix` with `Socket connect failed to 127.0.0.1:31501 (111 Connection refused)` right after recovery relaunch, despite subsequent manual reruns succeeding.
  - root cause: orchestrator retry path relaunched shootmania but retried communication-backed steps before ManiaControl communication socket was ready; additional container recreation churn increased race frequency.
  - fix: harden `pixel-sm-server/scripts/test-automated-suite.sh` recovery helper to (a) centralize retry execution, (b) remove stale shootmania containers by discovered name pattern before relaunch, and (c) block on communication socket readiness (`PIXEL_SM_AUTOMATED_SUITE_COMM_HOST/PORT/WAIT_ATTEMPTS`, defaults `127.0.0.1:31501`, `45`) before retrying communication steps.
  - validation: full orchestrator rerun passed end-to-end at `pixel-sm-server/logs/qa/automated-suite-20260222-003125/suite-summary.json`.

## Additional execution status (2026-02-22, crash-recovery score commands)
- Admin control surface now supports manual score recovery actions for BO/map continuity after runtime/script reset:
  - `match.maps.set target_team=<0|1|red|blue> maps_score=<int>` (maps won in current BO),
  - `match.score.set target_team=<0|1|red|blue> score=<int>` (rounds won on current map).
- Team selector normalization is now canonical in runtime policy state (`0|blue|team_a|a` -> `team_a`, `1|red|team_b|b` -> `team_b`), including quoted input tolerance for `target_team` values.
- `series_targets` snapshots now include additive recovery fields:
  - `maps_score.team_a|team_b`,
  - `current_map_score.team_a|team_b`.
- QA admin matrix now includes deterministic coverage for `match.bo.get`, `match.bo.set`, `match.maps.get/set`, and `match.score.get/set` in `pixel-sm-server/scripts/qa-admin-payload-sim.sh`.
- Latest evidence:
  - first matrix run before runtime sync: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-101744/summary.md` (new actions reported `action_unknown`),
  - post hot-sync successful matrix run: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-101845/summary.md`,
  - renamed-action matrix rerun summary: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-104241/summary.md` (`match.bo.get/set`, `match.maps.get/set`, `match.score.get/set` all `success=true`),
  - payload artifacts: `execute-15-match-bo-set.json`, `execute-18-match-maps-get.json`, `execute-21-match-score-get.json` under `pixel-sm-server/logs/qa/admin-payload-sim-20260222-104241/`.
- Incident memory (2026-02-22, action rename from `match.series.*` to explicit BO/maps/score get-set):
  - symptom: `match.series.set/status` naming mixed BO policy and score-recovery semantics, and did not expose explicit read actions for maps/round scores.
  - root cause: first design bundled unrelated policy targets into one command family, while crash-recovery flow requires explicit operations (`bo`, `maps_score`, `current_map_score`) with deterministic getters.
  - fix: replace catalog/actions with `match.bo.set`, `match.bo.get`, `match.maps.set`, `match.maps.get`, `match.score.set`, `match.score.get`; remove runtime `map_count_target`/`team_*_score_target` fields from `SeriesControlState`; update docs and QA matrix script accordingly.
  - validation: `php -l` passed on touched plugin files, admin matrix passed at `admin-payload-sim-20260222-104241/summary.md`, and veto matrix non-regression passed at `veto-payload-sim-20260222-104323/summary.md`.
- Incident memory (2026-02-22, new admin actions returned `action_unknown` right after code edit):
  - symptom: `qa-admin-payload-sim.sh matrix` reported `match.maps.set` / `match.score.set` as `action_unknown` although source code defined both actions.
  - root cause: running ManiaControl process was still on previous plugin code (runtime plugin not hot-synced/reloaded after local edits).
  - fix: run `bash pixel-sm-server/scripts/dev-plugin-hot-sync.sh` to sync plugin into container and restart ManiaControl process only, then rerun matrix.
  - validation: rerun matrix reported `match.maps.set` and `match.score.set` as `success=true`, `code=ok` in `admin-payload-sim-20260222-101845/summary.md`.

## Additional execution status (2026-02-22, modular automated-suite action descriptors)
- `pixel-sm-server/scripts/test-automated-suite.sh` now resolves required admin action coverage from modular descriptor scripts instead of hardcoded action arrays.
- Descriptor root: `pixel-sm-server/scripts/automated-suite/admin-actions/` (one `.sh` file per admin action key).
- Descriptor contract is documented in `pixel-sm-server/scripts/automated-suite/README.md`.
- Current descriptor set covers 24 actions including BO/maps/score get-set (`match.bo.set/get`, `match.maps.set/get`, `match.score.set/get`).

## Additional execution status (2026-02-22, veto help UX + series persistence hardening)
- `pcveto help` now resolves visibility from caller permissions and effective mode:
  - non-admin callers do not receive admin-only docs,
  - admin callers receive mode-specific admin docs only,
  - effective mode policy is now explicit: active session mode when running, otherwise configured default mode, with deterministic fallback guidance when mode context is invalid.
- Series persistence scope is now durable through ManiaControl settings:
  - persisted keys: `best_of`, `maps_score.team_a|team_b`, `current_map_score.team_a|team_b`,
  - mutation paths covered: `match.bo.set`, `match.maps.set`, `match.score.set`,
  - persistence failures now return deterministic `setting_write_failed` and rollback runtime snapshot to pre-write state.
- Latest evidence for this scope:
  - pre-restart set/get baseline: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110802/` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110806/`,
  - full container restart with env overrides cleared + post-restart verification: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110852/` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110853/`,
  - plugin hot-restart verification: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-111100/` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-111102/`,
  - non-regression matrices: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-110902/summary.md` and `pixel-sm-server/logs/qa/admin-payload-sim-20260222-110935/summary.md`.
- Incident memory (2026-02-22, persistence QA masked by env precedence):
  - symptom: BO/mode/duration persistence appeared inconsistent across restarts when container defaults were still exported.
  - root cause: runtime precedence is env-first; non-empty `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_*` values mask persisted settings during bootstrap checks.
  - fix: recreate `shootmania` with `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_BEST_OF=`, `PIXEL_CONTROL_VETO_DRAFT_DEFAULT_MODE=`, and `PIXEL_CONTROL_VETO_DRAFT_MATCHMAKING_DURATION_SECONDS=` for persistence-focused QA runs.
  - validation: after restart, getters returned persisted series snapshot with `update_source=setting` and `updated_by=plugin_bootstrap`.

## Additional execution status (2026-02-22, veto countdown + threshold autostart + completion apply policy)
- Matchmaking veto countdown now emits deterministic markers and chat announcements from configured duration (`N, N-10, ..., 10, 5/4/3/2/1`), deduped per `<session_id, remaining_second>`.
- Matchmaking threshold auto-start is now configurable and persisted through `//pcveto min_players <int>` (`matchmaking_autostart_min_players` in `PixelControl.VetoDraft.Status`).
- Threshold auto-start gating uses connected human players (`PlayerManager::getPlayerCount(false, true)`), with anti-loop state markers: `armed`, `triggered`, `suppressed`, `below_threshold`.
- Completion map-order application is now branch-deterministic:
  - `opener_differs`: queue full order then apply `map.skip` to opener,
  - `opener_already_current`: queue remaining maps only, no opener restart/skip.
- Latest evidence for this scope:
  - veto status snapshot with threshold field: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-131059/status.json`,
  - veto matrix rerun: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-130832/summary.md`,
  - admin matrix rerun: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-130914/summary.md`,
  - runtime countdown/autostart/apply markers: `pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log`.
- Incident memory (2026-02-22, opener jump failure on completion path):
  - symptom: completion apply returned `map_skip_failed` while queue updates succeeded.
  - root cause: direct opener jump (`skipToMapByUid`) was not reliable in this runtime path for immediate post-veto transitions.
  - fix: switch opener-differs branch to deterministic `map.skip` after queueing opener-first order.
  - validation: runtime logs show `[PixelControl][veto][apply_success] ... branch=opener_differs ... skip_code=skip_applied` and opener-already-current branch shows `skip_code=skip_not_required`.
- Gotcha (2026-02-22, chat evidence capture):
  - ManiaControl runtime log does not reliably persist `sendInformation(...)` chat lines, so chat-text assertions (`Map vote IDs`, `Available veto IDs`, countdown chat text) should be validated with live client/chat capture or complementary observability markers.

## Additional execution status (2026-02-22, veto role visibility + status scoping + vote reset)
- Role-based veto map visibility is now enforced on chat/control surface:
  - non-admin map listings are index/name only,
  - admin listings keep UID-capable rows.
- Completion diagnostics are now admin-only:
  - `Series order`, `Completion branch`, and `Opener jump` are scoped to veto-control audience.
- `/pcveto status` visibility is now role-scoped:
  - non-admin sees veto-result projection only,
  - admin keeps operational diagnostics (`Map draft/veto status`, no-active-session guidance, vote/turn details, series config).
- Matchmaking countdown cadence now derives from configured duration and preserves per-session dedupe:
  - validated runtime example (`duration=15`) emitted `15,10,5,4,3,2,1` exactly once each in `pixel-sm-server/runtime/server/ManiaControl/ManiaControl.log`.
- Matchmaking start now hard-resets vote counters for fresh sessions:
  - coordinator executes explicit `resetVoteCounters()` on session bootstrap and retains zero-baseline status snapshot.
- Evidence root for this execution: `pixel-sm-server/logs/qa/veto-role-visibility-countdown-reset/`.
  - required replays: `veto-payload-sim-20260222-135435/status.json`, `veto-payload-sim-20260222-135436/summary.md`, `admin-payload-sim-20260222-135454/summary.md`.
  - deterministic reset proof set: `veto-payload-sim-20260222-135328/`, `veto-payload-sim-20260222-135330/`, `veto-payload-sim-20260222-135333/`, `veto-payload-sim-20260222-135336/`, `veto-payload-sim-20260222-135338/`.
  - latest hot-sync validation logs: `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260222-140056.log` and `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260222-140056.log`.

## Additional execution status (2026-02-22, veto QA control-surface hardening)
- Veto matrix runtime flow is now modularized with one-file-per-step scripts in `pixel-sm-server/scripts/qa-veto-matrix-actions/` (`01..08`), consumed by `pixel-sm-server/scripts/qa-veto-payload-sim.sh matrix`.
- Veto matrix now emits strict machine-readable assertion artifacts:
  - `matrix-step-manifest.ndjson`,
  - `matrix-context.json`,
  - `matrix-validation.json` (required-check pass/fail source of truth).
- Automated suite veto required gates are now descriptor-driven through `pixel-sm-server/scripts/automated-suite/veto-checks/` (one check id per `.sh` file), similar to admin-action descriptors.
- Latest green evidence set for this hardening scope:
  - veto command checks: `veto-payload-sim-20260222-144529/` (`status.json`), `veto-payload-sim-20260222-144542/` (`start.json`), `veto-payload-sim-20260222-144558/` (`action.json`), `veto-payload-sim-20260222-144608/` (`cancel.json`),
  - veto matrix strict pass: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-144619/matrix-validation.json`,
  - admin matrix non-regression: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-144651/summary.md`,
  - automated suite full revalidation: `pixel-sm-server/logs/qa/automated-suite-20260222-144712/suite-summary.json` (`checks_total=39`, `passed=39`, `required_failures=0`).
- Hardening audit/index root: `pixel-sm-server/logs/qa/veto-control-surface-hardening-20260222-141438/` (`inventory.md`, `gap-analysis.md`, `evidence-index.md`).
- Contract note: this scope changed QA tooling/assertion coverage only; no additive/breaking communication contract change was introduced.
- Incident memory (2026-02-22, joust tournament compatibility false-negative in veto required checks):
  - symptom: `test-automated-suite.sh --modes elite,joust` failed required veto checks after matrix completion (`negative.tournament.actor_not_allowed` and tournament action-count assumptions) even though runtime flow completed.
  - root cause: in some joust/BO1 compatibility paths, tournament progression can expose a `system` step where forcing an invalid actor is not applicable and may consume expected action budget.
  - fix: make veto matrix + validator compatibility-aware for `system` turn ownership and gate invalid-actor assertions only when the scenario is applicable.
  - validation: rerun passed at `pixel-sm-server/logs/qa/veto-payload-sim-20260222-144619/matrix-validation.json` and `pixel-sm-server/logs/qa/automated-suite-20260222-144712/suite-summary.json`.

## Additional execution status (2026-02-22, matchmaking lifecycle closure hardening)
- Matchmaking post-veto lifecycle strict matrix is now green after runtime fallback adjustment:
  - veto matrix pass: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-170121/matrix-validation.json` (`overall_passed=true`, `required_failed_checks=[]`),
  - admin non-regression pass: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-170205/summary.md`.
- Evidence index for this scope: `pixel-sm-server/logs/qa/matchmaking-lifecycle-evidence-index-20260222.md`.
- Runtime behavior note: lifecycle closure can still converge via fallback inference even if selected-map trigger helper logs `Could not reach selected map uid before timeout hops`.
- Incident memory (2026-02-22, matchmaking lifecycle stuck at `veto_completed` during strict matrix):
  - symptom: `qa-veto-payload-sim.sh matrix` repeatedly failed required checks (`flow.matchmaking.lifecycle.sequence`, `flow.matchmaking.lifecycle.ready_state`) while status snapshots stayed `stage=veto_completed`.
  - root cause: `evaluateMatchmakingLifecycleRuntimeFallback()` returned early when current map UID was unavailable, which prevented timeout-based stage inference from progressing to `selected_map_loaded`/`match_started` in callback-sparse runtime windows.
  - fix: allow timeout-based match-start inference to run before the empty-current-map early return, then gate end-of-cycle finalization on known current-map UID; hot-sync plugin and rerun strict matrix.
  - validation: strict veto matrix passed at `pixel-sm-server/logs/qa/veto-payload-sim-20260222-170121/matrix-validation.json` with required lifecycle checks green.
- Incident memory (2026-02-23, strict veto matrix flaky during lifecycle closure):
  - symptom: repeated `qa-veto-payload-sim.sh matrix` runs failed strict lifecycle checks (`flow.matchmaking.lifecycle.sequence`, `flow.matchmaking.lifecycle.ready_state`) with selected-map trigger warnings (`Change in progress` / map-end trigger timeout).
  - root cause: default matrix wait margin (`PIXEL_SM_VETO_SIM_WAIT_EXTRA_SECONDS=2`) can be too short for this runtime timing window, so lifecycle closure does not always converge before assertions execute.
  - fix: increase matrix default wait margin in `pixel-sm-server/scripts/qa-veto-payload-sim.sh` to `PIXEL_SM_VETO_SIM_WAIT_EXTRA_SECONDS=20` (still overridable by env/CLI) to reduce lifecycle-closure flake in default runs.
  - validation: first default rerun still failed on lifecycle completion (`map_change_failed`) at `pixel-sm-server/logs/qa/veto-payload-sim-20260223-123403/matrix-validation.json`; immediate default rerun passed at `pixel-sm-server/logs/qa/veto-payload-sim-20260223-123548/matrix-validation.json` (`overall_passed=true`, `required_failed_checks=[]`).

## Additional execution status (2026-02-22, explicit matchmaking ready gate)
- Matchmaking veto cycles are now explicitly armed per cycle (`//pcveto ready` on chat/admin surface and `PixelControl.VetoDraft.Ready` on communication surface).
- Start-path gating is unified for matchmaking mode only:
  - timer threshold auto-start,
  - vote bootstrap path,
  - direct start payload/chat path.
- Ready token semantics are now deterministic:
  - one-cycle token consumed on successful matchmaking start,
  - no automatic re-arm on completion/map transition,
  - explicit re-arm required for next cycle.
- Additive observability/contract fields now expose gate state:
  - `PixelControl.VetoDraft.Status.matchmaking_ready_armed`,
  - `PixelControl.VetoDraft.Status.communication.ready` method availability,
  - lifecycle `map_rotation.matchmaking_ready_armed` telemetry.
- Ready-gate evidence index root: `pixel-sm-server/logs/qa/veto-ready-gate-20260222-1807/` (`summary.md`, `evidence-index.md`).
- Canonical QA runs for this scope:
  - veto matrix strict pass: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-180544/matrix-validation.json` (`overall_passed=true`, `required_failed_checks=[]`),
  - admin matrix non-regression pass: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-180638/summary.md`,
  - optional automated suite revalidation pass: `pixel-sm-server/logs/qa/automated-suite-20260222-180955/suite-summary.json` (`checks_total=39`, `passed=39`, `required_failures=0`).
- Incident memory (2026-02-22, matchmaking veto auto-restarted without operator intent):
  - symptom: after matchmaking completion + transition, a new default-duration matchmaking cycle could restart without explicit operator action.
  - root cause: matchmaking start entrypoints were ungated and completion logic could re-arm autostart while threshold conditions remained satisfied.
  - fix: introduce explicit one-cycle ready token and enforce gating on all matchmaking start paths; remove automatic re-arming after completion.
  - validation: strict matrix checks `negative.matchmaking.ready_required_initial`, `flow.matchmaking.ready_arm`, `flow.matchmaking.ready_status`, `negative.matchmaking.ready_required_post_cycle`, and `flow.matchmaking.rearmed_vote_bootstrap` all passed in `pixel-sm-server/logs/qa/veto-payload-sim-20260222-180544/matrix-validation.json`.

## Additional execution status (2026-02-22, veto system refactor cleanup)
- Veto cleanup/refactor plan `PLAN-veto-system-refactor-cleanup.md` executed end-to-end with backward-compatible behavior.
- Dead-code removals (explicit zero-call-site audit before deletion):
  - `pixel-control-plugin/src/VetoDraft/MatchmakingVoteSession.php`: removed `getStatus()` and `getWinnerMapUid()`.
  - `pixel-control-plugin/src/VetoDraft/VetoDraftCoordinator.php`: removed `buildMapOrderFromStatus()`.
  - `pixel-control-plugin/src/VetoDraft/VetoDraftQueueApplier.php`: removed `applyMatchmakingWinner()`.
- Duplication cleanup in `pixel-control-plugin/src/Domain/VetoDraft/VetoDraftDomainTrait.php`:
  - centralized feature-disabled chat/communication answers,
  - centralized draft-default summary line builder + sender helper.
- Validation evidence for this cleanup:
  - hot-sync: `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260222-190852.log`, `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260222-190852.log`,
  - veto checks: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-190923/status.json`, `pixel-sm-server/logs/qa/veto-payload-sim-20260222-191018/start.json`, `pixel-sm-server/logs/qa/veto-payload-sim-20260222-191117/action.json`, `pixel-sm-server/logs/qa/veto-payload-sim-20260222-191139/cancel.json`, `pixel-sm-server/logs/qa/veto-payload-sim-20260222-191154/matrix-validation.json`,
  - admin matrix: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-191239/summary.md`,
  - automated suite: `pixel-sm-server/logs/qa/automated-suite-20260222-191321/suite-summary.json` (`total_checks=39`, `passed_checks=39`, `required_failed_checks=0`).
- Contract note: no additive/breaking veto communication contract change in this cleanup scope.
- Incident memory (2026-02-22, standalone veto command replay can false-fail around ready gate timing):
  - symptom: standalone `qa-veto-payload-sim.sh start ... duration_seconds=8` / `action ... vote` runs intermittently returned `matchmaking_ready_required` during manual step-by-step replay.
  - root cause: one-cycle ready token is consumed on successful matchmaking start, and short-duration windows can close before delayed follow-up action calls.
  - fix: for deterministic manual command replays, run `ready` immediately before the start/action check (or use a chained `ready && action` sequence) so assertions execute inside an armed/active window.
  - validation: chained run succeeded with `vote_recorded` at `pixel-sm-server/logs/qa/veto-payload-sim-20260222-191117/action.json`.

## Additional execution status (2026-02-22, ready-gate unexpected player-kick guard)
- Matchmaking lifecycle cleanup policy is now non-destructive for real users:
  - cleanup eligibility is explicit allowlist only (`fake_players_only`),
  - human players are always skipped,
  - unknown/unclassified identities are skipped conservatively,
  - lifecycle finalization still continues when no players are eligible.
- Runtime observability was expanded for cleanup outcomes:
  - lifecycle action payload now includes additive `skipped_count`, `skipped_logins`, and `cleanup_policy`,
  - per-player markers are emitted as `[PixelControl][veto][matchmaking_lifecycle][kick_applied]` / `[...][kick_skipped]`.
- Validation evidence for this scope:
  - plugin lint: `php -l pixel-control-plugin/src/Domain/VetoDraft/VetoDraftDomainTrait.php`,
  - hot sync logs: `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260222-210605.log`, `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260222-210605.log`,
  - veto matrix pass: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-210658/matrix-validation.json`,
  - admin matrix pass: `pixel-sm-server/logs/qa/admin-payload-sim-20260222-210805/summary.md`,
  - full automated-suite rerun pass: `pixel-sm-server/logs/qa/automated-suite-20260222-212207/suite-summary.json` (`checks_total=39`, `passed=39`, `required_failures=0`),
  - lifecycle action snapshot with cleanup policy: `pixel-sm-server/logs/qa/veto-payload-sim-20260222-210658/step-14-status-matchmaking-lifecycle-after_map_end.json` (`actions.kick_all_players.cleanup_policy=fake_players_only`).
- Incident replay note:
  - second real-account join/kick loop cannot be fully automated in this environment;
  - closest deterministic replay with fake-player injection is captured at `pixel-sm-server/logs/qa/veto-payload-sim-20260222-211206/` (strict lifecycle checks can remain timing-sensitive when selected-map end trigger does not converge).
- Incident memory (2026-02-22, unintended kick after `//pcveto ready` + second-account join):
  - symptom: after ready-gate arming and subsequent join flow, players could be disconnected unexpectedly during matchmaking lifecycle completion.
  - root cause: lifecycle cleanup path (`executeMatchmakingLifecycleKickAllPlayersAction`) previously applied broad kick behavior and did not enforce a strict human-exclusion policy.
  - fix: enforce fake-only cleanup eligibility with conservative fallback (`unknown => skip`) and keep lifecycle completion independent from cleanup eligibility count.
  - validation: required lint/hot-sync/veto-matrix/admin-matrix checks passed with additive cleanup-policy evidence in status artifacts.

## Additional execution status (2026-02-23, whitelist + vote policy + team roster milestone-1)
- Plan execution status: `PLAN-whitelist-vote-policy-team-control-milestone-1.md` phases 1-4 are implemented; phase 5 is partially complete with deterministic QA evidence captured, while real-client/team-mode gameplay verification remains pending.
- New plugin state modules are now first-party and wired into runtime bootstrap + admin delegation:
  - whitelist: `pixel-control-plugin/src/AccessControl/{WhitelistCatalog,WhitelistStateInterface,WhitelistState}.php`,
  - vote policy: `pixel-control-plugin/src/VoteControl/{VotePolicyCatalog,VotePolicyStateInterface,VotePolicyState}.php`,
  - team roster: `pixel-control-plugin/src/TeamControl/{TeamRosterCatalog,TeamRosterStateInterface,TeamRosterState}.php`.
- New runtime domain traits are now integrated in plugin load/timers/callback flow:
  - `pixel-control-plugin/src/Domain/AccessControl/AccessControlDomainTrait.php`,
  - `pixel-control-plugin/src/Domain/TeamControl/TeamControlDomainTrait.php`.
- Callback registry now includes vote callback wiring (`CallbackManager::CB_MP_VOTEUPDATED`) to `handleVoteCallback(...)` for non-admin vote cancellation policy.
- Admin delegated action surface now includes additive whitelist/vote-policy/team-roster controls:
  - `whitelist.enable|disable|add|remove|list|clean|sync`,
  - `vote.policy.get|set`,
  - `team.policy.get|set`,
  - `team.roster.assign|unassign|list`.
- New policy settings/env surface:
  - whitelist: `Pixel Control Whitelist Enabled` / `PIXEL_CONTROL_WHITELIST_ENABLED`, `Pixel Control Whitelist Logins` / `PIXEL_CONTROL_WHITELIST_LOGINS`,
  - vote policy: `Pixel Control Vote Policy Mode` / `PIXEL_CONTROL_VOTE_POLICY_MODE`,
  - team control: `Pixel Control Team Policy Enabled` / `PIXEL_CONTROL_TEAM_POLICY_ENABLED`, `Pixel Control Team Switch Lock Enabled` / `PIXEL_CONTROL_TEAM_SWITCH_LOCK_ENABLED`, `Pixel Control Team Roster Assignments` / `PIXEL_CONTROL_TEAM_ROSTER_ASSIGNMENTS`.
- QA module extensions for this scope are now first-party:
  - matrix action steps: `pixel-sm-server/scripts/qa-admin-matrix-actions/27-whitelist-enable.sh`, `28-whitelist-add.sh`, `29-whitelist-list.sh`, `30-vote-policy-set.sh`, `31-team-roster-assign.sh`,
  - automated-suite admin descriptors now include the full new access/team policy families under `pixel-sm-server/scripts/automated-suite/admin-actions/` (`whitelist-*`, `vote-policy-*`, `team-policy-*`, `team-roster-*`).
- Validation/evidence (2026-02-23):
  - plugin lint pass across touched files (`php -l ...`),
  - hot-sync pass: `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260223-144233.log`, `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260223-144233.log`,
  - admin matrix pass with new actions: `pixel-sm-server/logs/qa/team-vote-whitelist-20260223-144310/admin-payload-sim-20260223-144311/summary.md`,
  - targeted execute evidence for new getters/setters/restoration: `pixel-sm-server/logs/qa/team-vote-whitelist-20260223-144407/targeted/`.
- Incident memory (2026-02-23, whitelist actions failed with `guest_list_sync_failed`):
  - symptom: `whitelist.enable` / `whitelist.add` returned `guest_list_sync_failed` with details `reason=Invalid file name.` during payload matrix replay.
  - root cause: guest-list sync called `saveGuestList('')`; this runtime rejects empty filename.
  - fix: sync path now applies `cleanGuestList` + `addGuest` first, then attempts `saveGuestList('guestlist.txt')` best-effort; save failures are downgraded to warning marker (`guest_sync_save_warning`) with runtime sync kept successful (`guest_list_sync_degraded`) so connect-time enforcement fallback still protects access.
  - validation: rerun matrix passed whitelist actions with `Action Success=true`, `Action Code=ok` at `team-vote-whitelist-20260223-144310/.../summary.md`.

## Additional execution status (2026-02-23, milestone-1 phase-5 continuation)
- Plan update: `PLAN-whitelist-vote-policy-team-control-milestone-1.md` now marks `P5.4.a` as done and keeps `P5.4.b` todo/manual.
- Autonomous phase-5 evidence root: `pixel-sm-server/logs/qa/team-vote-whitelist-20260223-145834/p5.4-autonomous/`.
  - required artifacts delivered: `summary.md`, `vote-policy-non-admin.json`, `fake-player-guard-observability.log`.
  - supporting probes include `vote-policy-dedicated-actions.log` and `fake-player-guard-probe.log`.
- Manual handoff scaffolding root: `pixel-sm-server/logs/manual/team-vote-whitelist-20260223-145834/`.
  - delivered templates: `MANUAL-TEST-MATRIX.md`, `INDEX.md`, `SESSION-session-001-notes.md`, `SESSION-session-001-payload.ndjson`, `SESSION-session-001-evidence.md`.
- Runtime state was restored after autonomous checks (whitelist disabled/cleaned, fake assignment removed, team policy disabled, vote policy set back to strict fallback, fake players disconnected).
- Incident memory (2026-02-23, fake-player XML-RPC helper misuse):
  - symptom: fake-player connection probe returned `null` and player count stayed `0`.
  - root cause: `connectFakePlayer` was called with a nickname argument; in this runtime API signature the first argument is `multicall` bool, so the call was treated as multicall queueing and did not return an immediate fake login.
  - fix: call `connectFakePlayer()` with no login argument and resolve the returned fake login.
  - validation: probe artifact `fake-player-connect.log` reported `fake_login=*fakeplayer1*` and `fake_present=yes`.
- Incident memory (2026-02-23, autonomous non-admin vote-cancel proof limitation):
  - symptom: fake-player vote probe could start a callvote but callback initiator was empty (`current_vote.callerLogin=""`).
  - root cause: dedicated API vote initiation path in this runtime does not expose a non-admin initiator login for the callback cancellation path.
  - fix: keep autonomous evidence as equivalent-scope only (no over-claim), and require real-client non-admin vote initiation for direct callback cancellation validation.
  - validation: `vote-policy-non-admin.json` records the limitation and keeps `P5.4.b` manual verification open.

## Additional execution status (2026-02-23, production-readiness refactor phase 0)
- Plan execution started for `PLAN-pixel-control-plugin-production-readiness-refactor.md`; phase-0 baseline contract (`P0.1..P0.6` + `P0.R`) is complete.
- Baseline inventory artifact captured at `pixel-control-plugin/logs/refactor-production-readiness/phase-0-baseline-inventory.md`:
  - plugin source baseline is `50` PHP files / `18,701` LOC,
  - high-risk hotspots remain `VetoDraftDomainTrait`, `PlayerDomainTrait`, `NativeAdminGateway`, `MatchDomainTrait`, `AdminControlDomainTrait`, and `LifecycleDomainTrait`.
- Documentation retention matrix captured at `pixel-control-plugin/logs/refactor-production-readiness/phase-0-doc-retention-matrix.md`:
  - target retained doc set after consolidation is `README.md` + `docs/event-contract.md` + `docs/schema/*`,
  - current audit/checklist/todo docs and `FEATURES.md` are planned for README merge then removal.
- Naming migration map captured at `pixel-control-plugin/logs/refactor-production-readiness/script-name-migration-map.md`:
  - frozen rename scope covers all plugin-facing `qa`/`smoke` scripts and matrix-step directories,
  - wrapper-based backward compatibility is required during transition.
- Phase gate matrix captured at `pixel-control-plugin/logs/refactor-production-readiness/phase-gate-acceptance-matrix.md` with measurable pass criteria for phases 1 through 7.
- Review packet artifact published at `pixel-control-plugin/logs/refactor-production-readiness/phase-0-review.md`.

## Additional execution status (2026-02-23, production-readiness refactor phase 1)
- Phase 1 (`P1.1..P1.4`) is complete with blueprint artifact at `pixel-control-plugin/logs/refactor-production-readiness/phase-1-architecture-blueprint.md`.
- Frozen architecture boundary model for extraction:
  - kernel (`PixelControlPlugin` + core lifecycle wiring),
  - ingress adapters (callbacks/chat/communication),
  - domain application services,
  - state stores,
  - runtime gateways/adapters,
  - pure builders/normalizers.
- Frozen high-risk decomposition target modules for phase-2 execution:
  - `VetoDraftDomainTrait` split into bootstrap/ingress/presentation/lifecycle/autostart/parser services,
  - `AdminControlDomainTrait` split into ingress/executor/persistence/correlation/help/normalization services,
  - `PlayerDomainTrait` split into source/snapshot/delta/correlation/constraint/roster builders,
  - `MatchDomainTrait` split into aggregate/team-assignment/win-context/map-rotation/veto-mirror services.
- Frozen compatibility guardrails before refactor coding:
  - keep admin/veto command names and communication method names stable,
  - keep envelope schema baseline `2026-02-20.1` unchanged,
  - keep existing operational marker families stable.
- Phase-1 review packet published at `pixel-control-plugin/logs/refactor-production-readiness/phase-1-review.md`.
- User process override applied during plan execution initially deferred user review until final consolidation; this was later superseded by explicit per-phase stop/review instruction (2026-02-23).

## Additional execution status (2026-02-23, production-readiness refactor phase 2)
- Phase 2 (`P2.1..P2.4`) is complete: high-risk monoliths are decomposed into focused subtraits while preserving runtime entrypoint behavior.
- New decomposition files are now first-party in plugin runtime:
  - veto: `pixel-control-plugin/src/Domain/VetoDraft/{VetoDraftBootstrapTrait,VetoDraftIngressTrait,VetoDraftLifecycleTrait,VetoDraftAutostartTrait}.php`,
  - admin: `pixel-control-plugin/src/Domain/Admin/{AdminControlBootstrapTrait,AdminControlExecutionTrait,AdminControlIngressTrait}.php`,
  - player: `pixel-control-plugin/src/Domain/Player/{PlayerSourceSnapshotTrait,PlayerContinuityCorrelationTrait,PlayerPolicySignalsTrait}.php`,
  - match: `pixel-control-plugin/src/Domain/Match/{MatchAggregateTelemetryTrait,MatchWinContextTrait,MatchVetoRotationTrait}.php`.
- Orchestrator facades now route through focused subtraits:
  - `pixel-control-plugin/src/Domain/VetoDraft/VetoDraftDomainTrait.php`,
  - `pixel-control-plugin/src/Domain/Admin/AdminControlDomainTrait.php`,
  - `pixel-control-plugin/src/Domain/Player/PlayerDomainTrait.php`,
  - `pixel-control-plugin/src/Domain/Match/MatchDomainTrait.php`.
- Parity evidence artifact captured at `pixel-control-plugin/logs/refactor-production-readiness/phase-2-parity-check.md`:
  - target-facade LOC reductions vs baseline are `>=99%` for all four high-risk traits,
  - method-set parity is exact (`missing=0`, `added=0`) across veto/admin/player/match domains,
  - plugin lint passed (`php -l` over `pixel-control-plugin/src/**/*.php`).
- Runtime non-regression evidence (post hot-sync):
  - hot-sync logs: `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260223-182555.log`, `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260223-182555.log`,
  - admin matrix pass: `pixel-sm-server/logs/qa/admin-payload-sim-20260223-182614/summary.md`,
  - veto matrix strict pass: `pixel-sm-server/logs/qa/veto-payload-sim-20260223-182645/matrix-validation.json` (`overall_passed=true`, `required_failed_checks=[]`).
- Phase-2 review packet published at `pixel-control-plugin/logs/refactor-production-readiness/phase-2-review.md`.

## Additional execution status (2026-02-23, production-readiness refactor phase 3)
- Phase 3 (`P3.0..P3.4`) is now complete with consistency cleanup, setting-resolution centralization, and dead-symbol removal while preserving runtime behavior.
- User-requested dead-symbol cleanup (`P3.0`) remained part of phase-3 scope and is captured in `pixel-control-plugin/logs/refactor-production-readiness/phase-3-unused-symbol-cleanup.md`.
- Supporting-domain consistency updates delivered:
  - `AccessControlDomainTrait`: explicit bootstrap-source helpers + explicit default snapshot builders,
  - `TeamControlDomainTrait`: explicit default snapshot builder + env-value helper usage,
  - `SeriesControlDomainTrait`: explicit default snapshot builder + env-value helper usage + removal of dead helper `updateSeriesControlBestOf`.
- Runtime-setting helper centralization delivered:
  - canonical `resolveRuntimeBoolSetting(...)`, `isRuntimeEnvDefined(...)`, and `hasRuntimeEnvValue(...)` now live in `pixel-control-plugin/src/Domain/Core/CoreDomainTrait.php`,
  - duplicate admin-local bool resolver removed from `pixel-control-plugin/src/Domain/Admin/AdminControlBootstrapTrait.php`.
- Import/readability cleanup now applied across domain traits (including non-refactored support traits):
  - `pixel-control-plugin/src/Domain/Combat/CombatDomainTrait.php`,
  - `pixel-control-plugin/src/Domain/Connectivity/ConnectivityDomainTrait.php`,
  - `pixel-control-plugin/src/Domain/Lifecycle/LifecycleDomainTrait.php`,
  - `pixel-control-plugin/src/Domain/Pipeline/PipelineDomainTrait.php`,
  - plus phase-2 split traits already captured in cleanup evidence.
- Validation after full phase-3 scope:
  - domain import scans report no remaining unused imports,
  - plugin lint still passes (`php -l` on `pixel-control-plugin/src/**/*.php`),
  - hot-sync completed at `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260223-195107.log` and `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260223-195107.log`,
  - admin matrix rerun passed at `pixel-sm-server/logs/qa/admin-payload-sim-20260223-195128/summary.md`,
  - veto matrix strict rerun passed at `pixel-sm-server/logs/qa/veto-payload-sim-20260223-195131/matrix-validation.json` (`overall_passed=true`, `required_failed_checks=[]`).
- Phase-3 review packet published at `pixel-control-plugin/logs/refactor-production-readiness/phase-3-review.md`.

## Additional execution status (2026-02-23, production-readiness refactor phase 4)
- Phase 4 (`P4.1..P4.5`) is complete with plugin-local testing foundation and deterministic regression coverage.
- Plugin-local test harness is now first-party under `pixel-control-plugin/tests/`:
  - bootstrap/runner: `tests/bootstrap.php`, `tests/run.php`,
  - support helpers: `tests/Support/{Assert,Fakes,Harnesses,ManiaControlStubs}.php`,
  - deterministic cases: `tests/cases/{00HarnessSmokeTest,10StateModuleTest,11VetoSessionStateTest,20IngressNormalizationTest,30OrchestrationSeamTest}.php`.
- Quality gate command is now first-party: `pixel-control-plugin/scripts/check-quality.sh` (lint `src`+`tests` then run local tests).
- Phase-4 validation result:
  - command: `bash pixel-control-plugin/scripts/check-quality.sh`,
  - output: `Lint OK for 74 files.` and `Result: passed=20, failed=0, total=20`.
- Phase-4 review packet published at `pixel-control-plugin/logs/refactor-production-readiness/phase-4-review.md`.
- Plan protocol update recorded: execution now pauses between phases for explicit user review before entering the next phase.

## Additional execution status (2026-02-23, production-readiness refactor phase 5)
- Phase 5 (`P5.1..P5.4`) is complete with documentation consolidation into a canonical plugin README and essential-only retained docs.
- `pixel-control-plugin/README.md` is now the canonical operator/developer guide and includes explicit sections for:
  - admin command/control surface,
  - veto command/control surface,
  - test script reference,
  - other development script reference,
  - retained machine-contract artifact rationale.
- Redundant docs were merged/removed from active surface:
  - removed `pixel-control-plugin/FEATURES.md`,
  - removed `pixel-control-plugin/docs/admin-capability-delegation.md`,
  - removed `pixel-control-plugin/docs/veto-system-test-checklist.md`,
  - removed `pixel-control-plugin/docs/manual-feature-test-todo.md`,
  - removed audit narratives under `pixel-control-plugin/docs/audit/`.
- Contract artifacts intentionally retained:
  - `pixel-control-plugin/docs/event-contract.md`,
  - `pixel-control-plugin/docs/schema/*.json`.
- Phase-5 review packet published at `pixel-control-plugin/logs/refactor-production-readiness/phase-5-review.md`.

## Additional execution status (2026-02-23, production-readiness refactor phase 6)
- Phase 6 script/file naming migration is now aligned to explicit, non-`qa` command names on active surfaces.
- Canonical renamed script entrypoints:
  - `pixel-sm-server/scripts/simulate-admin-control-payloads.sh` (replaces `qa-admin-payload-sim.sh`),
  - `pixel-sm-server/scripts/simulate-veto-control-payloads.sh` (replaces `qa-veto-payload-sim.sh`),
  - `pixel-sm-server/scripts/replay-admin-player-combat-telemetry.sh` (replaces `qa-admin-stats-replay.sh`),
  - `pixel-sm-server/scripts/validate-dev-stack-launch.sh` (replaces `qa-launch-smoke.sh`),
  - `pixel-sm-server/scripts/validate-mode-launch-matrix.sh` (replaces `qa-mode-smoke.sh`),
  - `pixel-sm-server/scripts/replay-core-telemetry-wave3.sh` (replaces `qa-wave3-telemetry-replay.sh`),
  - `pixel-sm-server/scripts/replay-extended-telemetry-wave4.sh` (replaces `qa-wave4-telemetry-replay.sh`).
- Compatibility wrappers remain available on the old script names and print deprecation messages while forwarding to canonical scripts.
- Canonical matrix-step extension roots are now:
  - `pixel-sm-server/scripts/admin-action-matrix-steps/`,
  - `pixel-sm-server/scripts/veto-action-matrix-steps/`.
- Automated-suite naming migration is now active:
  - optional flag `--with-mode-matrix-validation` is canonical,
  - deprecated alias `--with-mode-smoke` is still accepted with warning,
  - check ids use `launch_validation` / `optional.mode_validation.matrix` naming.
- Active docs/checklists updated to canonical names:
  - `pixel-control-plugin/README.md`,
  - `pixel-sm-server/README.md`,
  - `pixel-sm-server/SERVER-VALIDATION-CHECKLIST.md`,
  - `pixel-sm-server/scripts/automated-suite/README.md`.
- Validation signal for this migration scope:
  - `bash -n` passed for all touched/added scripts (renamed entrypoints + automated suite + compatibility wrappers),
  - `bash pixel-sm-server/scripts/test-automated-suite.sh --help` shows canonical flag/usage,
  - `simulate-admin-control-payloads.sh --help` and `simulate-veto-control-payloads.sh --help` show canonical command paths/default step directories.

## Additional execution status (2026-02-23, production-readiness refactor phase 7)
- Phase 7 production-readiness validation/handoff is complete.
- Validation evidence:
  - plugin quality gate pass via `bash pixel-control-plugin/scripts/check-quality.sh` (`Lint OK for 74 files`, `passed=20 failed=0 total=20`),
  - full renamed-workflow suite pass via `bash pixel-sm-server/scripts/test-automated-suite.sh --modes elite,joust` with artifacts under `pixel-sm-server/logs/qa/automated-suite-20260223-203704/` (`suite-summary.json`: `total_checks=39`, `passed_checks=39`, `required_failed_checks=0`),
  - canonical handoff package: `HANDOFF-pixel-control-plugin-production-readiness-refactor-2026-02-23.md`.
- Compatibility boundary confirmation in this phase:
  - no intentional plugin runtime contract changes,
  - control surface remains `PixelControl.Admin.*` + `PixelControl.VetoDraft.*` + `pcadmin` + `pcveto`,
  - schema baseline remains `2026-02-20.1`.
- Incident memory (2026-02-23, deprecated wrapper safety check pitfalls):
  - symptom: running `qa-wave3-telemetry-replay.sh --help` / `qa-wave4-telemetry-replay.sh --help` unexpectedly executed full replay flows and produced runtime failures (`curl: (7)` / stack-state errors) instead of returning lightweight help text.
  - root cause: replay scripts (and their wrappers) do not implement a `--help` command path; wrapper forwarding executes the target script directly.
  - fix: validate wrapper migration safety with `bash -n` and with help-capable wrappers (`qa-admin-payload-sim.sh`, `qa-veto-payload-sim.sh`) rather than assuming `--help` works for every wrapper.
  - validation: script syntax checks stayed green and canonical suite run still passed end-to-end (`automated-suite-20260223-203704`).

## Additional execution status (2026-02-24, pcadmin help family compaction)
- Plan `PLAN-pixel-control-plugin-pcadmin-help-family-compaction.md` is complete through phase 3.
- `//pcadmin help` output is now compact and family-grouped in plugin chat surface:
  - preserved unchanged first lines (`Pixel delegated admin actions (...)`, usage, server-link help),
  - action help now emits one line per derived command family (family key = action name prefix before final `.` segment),
  - per-family actions render as suffix labels with compact parameter hints (`req:` / `opt:`) and deterministic sort order.
- Backward-compatibility guard held for this scope:
  - no delegated action semantics/permission/execution changes,
  - no communication contract changes (`PixelControl.Admin.ListActions` / `PixelControl.Admin.ExecuteAction`).
- Deterministic plugin-local coverage was extended in `pixel-control-plugin/tests/cases/21AdminLinkAuthTest.php`:
  - new test validates compact family output, preserved header/usage/server-link lines, unique family line count parity, and absence of old `- map.skip` per-action flood format.
- Validation signals for this scope:
  - `php -l pixel-control-plugin/src/Domain/Admin/AdminControlIngressTrait.php` passed,
  - `php -l pixel-control-plugin/tests/cases/21AdminLinkAuthTest.php` passed,
  - targeted run `php pixel-control-plugin/tests/run.php --filter=21AdminLinkAuthTest.php` passed (`9/9`),
  - broader gate `bash pixel-control-plugin/scripts/check-quality.sh` passed (`Lint OK for 75 files`, `passed=29 failed=0 total=29`).
- Runtime sync after plugin edit completed via hot-sync preference:
  - `bash pixel-sm-server/scripts/dev-plugin-hot-sync.sh` passed,
  - evidence logs: `pixel-sm-server/logs/dev/dev-plugin-hot-sync-shootmania-20260224-152410.log` and `pixel-sm-server/logs/dev/dev-plugin-hot-sync-maniacontrol-20260224-152410.log`.

## User preference (durable)
- For QA automation scripts, prefer modular Bash structure with one script per tested action/feature rather than large hardcoded lists inside monolithic scripts.
- Matrix replay order for admin actions now lives in `pixel-sm-server/scripts/admin-action-matrix-steps/` (one sourced `.sh` step per action) and should remain the default extension point.
- Automated-suite required admin action catalog now lives in `pixel-sm-server/scripts/automated-suite/admin-actions/` (one `.sh` descriptor per action key) and should be updated whenever action coverage changes.
- After any plugin code modification request, run `bash pixel-sm-server/scripts/dev-plugin-hot-sync.sh` before reporting completion so runtime behavior matches source changes.
- When the user says `PLAN_EXECUTE`, treat it as explicit instruction to create a PLAN file with the `@planner` subagent and then execute that PLAN immediately with the `@executor` subagent.
- For each completed phase in a PLAN execution, provide an essential-only summary and immediate next steps.
- Any extra user-requested change/revert during PLAN execution must be appended as a new `[Todo]` step in the active phase before execution.
- During this production-readiness PLAN execution, continue through remaining phases when explicitly requested by user, create one local commit per phase, and do not push.
