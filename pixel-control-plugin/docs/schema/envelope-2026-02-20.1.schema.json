{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pixel-control.dev/schema/envelope-2026-02-20.1.schema.json",
  "title": "Pixel Control event envelope",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "event_name",
    "schema_version",
    "event_id",
    "event_category",
    "source_callback",
    "source_sequence",
    "source_time",
    "idempotency_key",
    "payload",
    "metadata"
  ],
  "properties": {
    "event_name": {
      "type": "string",
      "pattern": "^pixel_control\\.(connectivity|lifecycle|player|combat|mode)\\.[a-z0-9]+(?:_[a-z0-9]+)*$"
    },
    "schema_version": {
      "const": "2026-02-20.1"
    },
    "event_id": {
      "type": "string",
      "pattern": "^pc-evt-(connectivity|lifecycle|player|combat|mode)-[a-z0-9]+(?:_[a-z0-9]+)*-[1-9][0-9]*$"
    },
    "event_category": {
      "type": "string",
      "enum": [
        "connectivity",
        "lifecycle",
        "player",
        "combat",
        "mode"
      ]
    },
    "source_callback": {
      "type": "string",
      "minLength": 1
    },
    "source_sequence": {
      "type": "integer",
      "minimum": 1
    },
    "source_time": {
      "type": "integer",
      "minimum": 0
    },
    "idempotency_key": {
      "type": "string",
      "pattern": "^pc-idem-[a-f0-9]{40}$"
    },
    "payload": {
      "type": "object"
    },
    "metadata": {
      "type": "object"
    }
  },
  "$defs": {
    "connectivityEventName": {
      "type": "string",
      "enum": [
        "pixel_control.connectivity.plugin_registration",
        "pixel_control.connectivity.plugin_heartbeat"
      ]
    },
    "lifecycleEventName": {
      "type": "string",
      "enum": [
        "pixel_control.lifecycle.maniaplanet_beginmatch",
        "pixel_control.lifecycle.maniaplanet_endmatch",
        "pixel_control.lifecycle.maniaplanet_beginmap",
        "pixel_control.lifecycle.maniaplanet_endmap",
        "pixel_control.lifecycle.maniaplanet_beginround",
        "pixel_control.lifecycle.maniaplanet_endround",
        "pixel_control.lifecycle.maniaplanet_warmup_start",
        "pixel_control.lifecycle.maniaplanet_warmup_end",
        "pixel_control.lifecycle.maniaplanet_warmup_status",
        "pixel_control.lifecycle.maniaplanet_startmatch_start",
        "pixel_control.lifecycle.maniaplanet_startmatch_end",
        "pixel_control.lifecycle.maniaplanet_endmatch_start",
        "pixel_control.lifecycle.maniaplanet_endmatch_end",
        "pixel_control.lifecycle.maniaplanet_loadingmap_start",
        "pixel_control.lifecycle.maniaplanet_loadingmap_end",
        "pixel_control.lifecycle.maniaplanet_unloadingmap_start",
        "pixel_control.lifecycle.maniaplanet_unloadingmap_end",
        "pixel_control.lifecycle.maniaplanet_startround_start",
        "pixel_control.lifecycle.maniaplanet_startround_end",
        "pixel_control.lifecycle.maniaplanet_endround_start",
        "pixel_control.lifecycle.maniaplanet_endround_end"
      ]
    },
    "playerEventName": {
      "type": "string",
      "enum": [
        "pixel_control.player.playermanagercallback_playerconnect",
        "pixel_control.player.playermanagercallback_playerdisconnect",
        "pixel_control.player.playermanagercallback_playerinfochanged",
        "pixel_control.player.playermanagercallback_playerinfoschanged"
      ]
    },
    "combatEventName": {
      "type": "string",
      "enum": [
        "pixel_control.combat.shootmania_event_onshoot",
        "pixel_control.combat.shootmania_event_onhit",
        "pixel_control.combat.shootmania_event_onnearmiss",
        "pixel_control.combat.shootmania_event_onarmorempty",
        "pixel_control.combat.shootmania_event_oncapture",
        "pixel_control.combat.shootmania_event_scores"
      ]
    },
    "modeEventName": {
      "type": "string",
      "enum": [
        "pixel_control.mode.shootmania_elite_startturn",
        "pixel_control.mode.shootmania_elite_endturn",
        "pixel_control.mode.shootmania_joust_onreload",
        "pixel_control.mode.shootmania_joust_selectedplayers",
        "pixel_control.mode.shootmania_joust_roundresult",
        "pixel_control.mode.shootmania_royal_points",
        "pixel_control.mode.shootmania_royal_playerspawn",
        "pixel_control.mode.shootmania_royal_roundwinner"
      ]
    },
    "callbackSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "arguments_count",
        "arguments"
      ],
      "properties": {
        "arguments_count": {
          "type": "integer",
          "minimum": 0
        },
        "arguments": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "type",
              "value"
            ],
            "properties": {
              "type": {
                "type": "string"
              },
              "value": {}
            }
          }
        }
      }
    },
    "runtimeContext": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "server",
        "players"
      ],
      "properties": {
        "server": {
          "type": "object",
          "additionalProperties": true
        },
        "players": {
          "type": "object",
          "additionalProperties": true,
          "required": [
            "active",
            "total",
            "spectators"
          ],
          "properties": {
            "active": {
              "type": "integer",
              "minimum": 0
            },
            "total": {
              "type": "integer",
              "minimum": 0
            },
            "spectators": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      }
    },
    "connectivityPayload": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": true,
          "required": [
            "type",
            "plugin",
            "capabilities",
            "context",
            "timestamp"
          ],
          "properties": {
            "type": {
              "const": "plugin_registration"
            },
            "plugin": {
              "type": "object"
            },
            "capabilities": {
              "type": "object"
            },
            "context": {
              "$ref": "#/$defs/runtimeContext"
            },
            "timestamp": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        {
          "type": "object",
          "additionalProperties": true,
          "required": [
            "type",
            "queue_depth",
            "context",
            "timestamp"
          ],
          "properties": {
            "type": {
              "const": "plugin_heartbeat"
            },
            "queue_depth": {
              "type": "integer",
              "minimum": 0
            },
            "context": {
              "$ref": "#/$defs/runtimeContext"
            },
            "timestamp": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      ]
    },
    "callbackMetadata": {
      "type": "object",
      "additionalProperties": true,
      "required": [
        "plugin_version",
        "schema_version",
        "mode_family",
        "signal_kind"
      ],
      "properties": {
        "plugin_version": {
          "type": "string"
        },
        "schema_version": {
          "const": "2026-02-20.1"
        },
        "mode_family": {
          "const": "multi-mode"
        },
        "signal_kind": {
          "const": "callback"
        }
      }
    },
    "connectivityMetadata": {
      "type": "object",
      "additionalProperties": true,
      "required": [
        "plugin_version",
        "schema_version",
        "mode_family",
        "signal_kind",
        "context"
      ],
      "properties": {
        "plugin_version": {
          "type": "string"
        },
        "schema_version": {
          "const": "2026-02-20.1"
        },
        "mode_family": {
          "const": "multi-mode"
        },
        "signal_kind": {
          "const": "connectivity"
        },
        "context": {
          "$ref": "#/$defs/runtimeContext"
        }
      }
    },
    "lifecycleMetadata": {
      "type": "object",
      "additionalProperties": true,
      "required": [
        "plugin_version",
        "schema_version",
        "mode_family",
        "signal_kind",
        "lifecycle_variant",
        "context"
      ],
      "properties": {
        "plugin_version": {
          "type": "string"
        },
        "schema_version": {
          "const": "2026-02-20.1"
        },
        "mode_family": {
          "const": "multi-mode"
        },
        "signal_kind": {
          "const": "callback"
        },
        "lifecycle_variant": {
          "type": "string"
        },
        "context": {
          "$ref": "#/$defs/runtimeContext"
        }
      }
    },
    "playerSnapshot": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "login",
        "nickname",
        "team_id",
        "is_spectator",
        "is_connected",
        "has_joined_game",
        "auth_level",
        "auth_name",
        "auth_role",
        "is_referee",
        "has_player_slot",
        "is_server",
        "is_fake",
        "connectivity_state"
      ],
      "properties": {
        "login": {
          "type": "string"
        },
        "nickname": {
          "type": "string"
        },
        "team_id": {
          "type": [
            "integer",
            "null"
          ]
        },
        "is_spectator": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_temporary_spectator": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_pure_spectator": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_connected": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "has_joined_game": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "forced_spectator_state": {
          "type": [
            "integer",
            "null"
          ]
        },
        "auth_level": {
          "type": [
            "integer",
            "null"
          ]
        },
        "auth_name": {
          "type": "string"
        },
        "auth_role": {
          "type": "string"
        },
        "is_referee": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "has_player_slot": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_managed_by_other_server": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_broadcasting": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_podium_ready": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_official": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_server": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_fake": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "connectivity_state": {
          "type": "string",
          "enum": [
            "connected",
            "disconnected",
            "unknown"
          ]
        },
        "readiness_state": {
          "type": "string",
          "enum": [
            "ready",
            "connected_idle",
            "joining",
            "waiting_slot",
            "spectating",
            "spectating_temporary",
            "disconnected",
            "unknown"
          ]
        },
        "eligibility_state": {
          "type": "string",
          "enum": [
            "eligible",
            "restricted",
            "ineligible",
            "unknown"
          ]
        },
        "can_join_round": {
          "type": [
            "boolean",
            "null"
          ]
        }
      }
    },
    "playerStateDeltaEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "before",
        "after",
        "changed"
      ],
      "properties": {
        "before": {
          "type": [
            "string",
            "integer",
            "boolean",
            "null"
          ]
        },
        "after": {
          "type": [
            "string",
            "integer",
            "boolean",
            "null"
          ]
        },
        "changed": {
          "type": "boolean"
        }
      }
    },
    "playerStateDelta": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "connectivity",
        "spectator",
        "team_id",
        "auth_level",
        "auth_role",
        "is_referee",
        "has_player_slot"
      ],
      "properties": {
        "connectivity": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "spectator": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "team_id": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "auth_level": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "auth_role": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "is_referee": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "has_player_slot": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "has_joined_game": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "forced_spectator_state": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "is_temporary_spectator": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "readiness_state": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "eligibility_state": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        },
        "can_join_round": {
          "$ref": "#/$defs/playerStateDeltaEntry"
        }
      }
    },
    "playerPermissionSignals": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "auth_level",
        "auth_name",
        "auth_role",
        "is_referee",
        "has_player_slot",
        "can_admin_actions",
        "auth_level_changed",
        "role_changed"
      ],
      "properties": {
        "auth_level": {
          "type": [
            "integer",
            "null"
          ]
        },
        "auth_name": {
          "type": "string"
        },
        "auth_role": {
          "type": "string"
        },
        "is_referee": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "has_player_slot": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "can_admin_actions": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "readiness_state": {
          "type": "string"
        },
        "eligibility_state": {
          "type": "string"
        },
        "can_join_round": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "forced_spectator_state": {
          "type": [
            "integer",
            "null"
          ]
        },
        "is_temporary_spectator": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "is_managed_by_other_server": {
          "type": [
            "boolean",
            "null"
          ]
        },
        "auth_level_changed": {
          "type": "boolean"
        },
        "role_changed": {
          "type": "boolean"
        },
        "slot_changed": {
          "type": "boolean"
        },
        "readiness_changed": {
          "type": "boolean"
        },
        "eligibility_changed": {
          "type": "boolean"
        },
        "field_availability": {
          "type": "object",
          "additionalProperties": {
            "type": "boolean"
          }
        },
        "missing_fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "rosterStateTelemetry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "current",
        "previous",
        "delta",
        "aggregate",
        "field_availability",
        "missing_fields"
      ],
      "properties": {
        "current": {
          "type": "object",
          "additionalProperties": true
        },
        "previous": {
          "type": "object",
          "additionalProperties": true
        },
        "delta": {
          "type": "object",
          "additionalProperties": true
        },
        "aggregate": {
          "type": "object",
          "additionalProperties": true
        },
        "field_availability": {
          "type": "object",
          "additionalProperties": {
            "type": "boolean"
          }
        },
        "missing_fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "playerAdminCorrelation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "correlated",
        "window_seconds",
        "confidence",
        "matched_by",
        "seconds_since_admin_action",
        "inference_reasons",
        "admin_event",
        "field_availability",
        "missing_fields"
      ],
      "properties": {
        "correlated": {
          "type": "boolean"
        },
        "window_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "confidence": {
          "type": "string"
        },
        "matched_by": {
          "type": "string"
        },
        "seconds_since_admin_action": {
          "type": [
            "integer",
            "null"
          ]
        },
        "inference_reasons": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "admin_event": {
          "oneOf": [
            {
              "type": "object",
              "additionalProperties": true
            },
            {
              "type": "null"
            }
          ]
        },
        "field_availability": {
          "type": "object",
          "additionalProperties": {
            "type": "boolean"
          }
        },
        "missing_fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "playerPayload": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "event_kind",
        "transition_kind",
        "source_callback",
        "player",
        "previous_player",
        "state_delta",
        "permission_signals",
        "roster_snapshot",
        "tracked_player_cache_size",
        "field_availability",
        "missing_fields",
        "raw_callback_summary"
      ],
      "properties": {
        "event_kind": {
          "type": "string",
          "enum": [
            "player.connect",
            "player.disconnect",
            "player.info_changed",
            "player.infos_changed",
            "player.unknown"
          ]
        },
        "transition_kind": {
          "type": "string",
          "enum": [
            "connectivity",
            "state_change",
            "batch_refresh",
            "unknown"
          ]
        },
        "source_callback": {
          "type": "string",
          "minLength": 1
        },
        "player": {
          "oneOf": [
            {
              "$ref": "#/$defs/playerSnapshot"
            },
            {
              "type": "null"
            }
          ]
        },
        "previous_player": {
          "oneOf": [
            {
              "$ref": "#/$defs/playerSnapshot"
            },
            {
              "type": "null"
            }
          ]
        },
        "state_delta": {
          "$ref": "#/$defs/playerStateDelta"
        },
        "permission_signals": {
          "$ref": "#/$defs/playerPermissionSignals"
        },
        "roster_state": {
          "$ref": "#/$defs/rosterStateTelemetry"
        },
        "admin_correlation": {
          "$ref": "#/$defs/playerAdminCorrelation"
        },
        "reconnect_continuity": {
          "type": "object",
          "additionalProperties": true
        },
        "side_change": {
          "type": "object",
          "additionalProperties": true
        },
        "constraint_signals": {
          "type": "object",
          "additionalProperties": true
        },
        "roster_snapshot": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "active",
            "total",
            "spectators"
          ],
          "properties": {
            "active": {
              "type": "integer",
              "minimum": 0
            },
            "total": {
              "type": "integer",
              "minimum": 0
            },
            "spectators": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "tracked_player_cache_size": {
          "type": "integer",
          "minimum": 0
        },
        "field_availability": {
          "type": "object",
          "additionalProperties": {
            "type": "boolean"
          }
        },
        "missing_fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "batch_scope": {
          "type": "string"
        },
        "raw_callback_summary": {
          "$ref": "#/$defs/callbackSummary"
        }
      }
    },
    "combatPayload": {
      "type": "object",
      "additionalProperties": true,
      "required": [
        "event_kind",
        "counter_scope",
        "player_counters",
        "tracked_player_count",
        "dimensions",
        "field_availability",
        "missing_dimensions",
        "raw_callback_summary"
      ],
      "properties": {
        "event_kind": {
          "type": "string",
          "minLength": 1
        },
        "counter_scope": {
          "const": "runtime_session"
        },
        "player_counters": {
          "type": "object"
        },
        "tracked_player_count": {
          "type": "integer",
          "minimum": 0
        },
        "dimensions": {
          "type": "object"
        },
        "field_availability": {
          "type": "object"
        },
        "missing_dimensions": {
          "type": "array"
        },
        "raw_callback_summary": {
          "$ref": "#/$defs/callbackSummary"
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "event_category": {
            "const": "connectivity"
          }
        }
      },
      "then": {
        "properties": {
          "event_name": {
            "$ref": "#/$defs/connectivityEventName"
          },
          "payload": {
            "$ref": "#/$defs/connectivityPayload"
          },
          "metadata": {
            "$ref": "#/$defs/connectivityMetadata"
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "event_category": {
            "const": "lifecycle"
          }
        }
      },
      "then": {
        "properties": {
          "event_name": {
            "$ref": "#/$defs/lifecycleEventName"
          },
          "payload": {
            "$ref": "lifecycle-payload-2026-02-20.1.schema.json"
          },
          "metadata": {
            "$ref": "#/$defs/lifecycleMetadata"
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "event_category": {
            "const": "player"
          }
        }
      },
      "then": {
        "properties": {
          "event_name": {
            "$ref": "#/$defs/playerEventName"
          },
          "payload": {
            "$ref": "#/$defs/playerPayload"
          },
          "metadata": {
            "$ref": "#/$defs/callbackMetadata"
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "event_category": {
            "const": "combat"
          }
        }
      },
      "then": {
        "properties": {
          "event_name": {
            "$ref": "#/$defs/combatEventName"
          },
          "payload": {
            "$ref": "#/$defs/combatPayload"
          },
          "metadata": {
            "$ref": "#/$defs/callbackMetadata"
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "event_category": {
            "const": "mode"
          }
        }
      },
      "then": {
        "properties": {
          "event_name": {
            "$ref": "#/$defs/modeEventName"
          },
          "payload": {
            "$ref": "#/$defs/callbackSummary"
          },
          "metadata": {
            "$ref": "#/$defs/callbackMetadata"
          }
        }
      }
    }
  ]
}
